<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Waraf | Product Details</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/auth.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .product-details-nav {
      display: flex;
      background-color: rgba(56, 181, 147, 0.1);
      border-radius: 8px;
      margin-bottom: 25px;
      overflow: hidden;
    }

    .product-details-nav-item {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    .product-details-nav-item.active {
      background-color: rgba(56, 181, 147, 0.2);
      border-bottom: 3px solid var(--accent-color);
      color: white;
    }

    .product-details-nav-item:hover:not(.active) {
      background-color: rgba(56, 181, 147, 0.1);
      color: white;
    }

    .product-details-content {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 25px;
      min-height: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .product-details-section {
      display: none;
    }

    .product-details-section.active {
      display: block;
    }

    .product-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .product-details-title {
      display: flex;
      align-items: center;
    }

    .product-details-title h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    .product-details-title span {
      background-color: rgba(56, 181, 147, 0.2);
      color: var(--accent-color);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-left: 15px;
      font-weight: 500;
    }

    .back-button {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .back-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .back-button svg {
      margin-right: 8px;
    }

    .section-title {
      color: var(--accent-color);
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 15px;
    }

    .placeholder-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
    }

    .placeholder-content svg {
      width: 64px;
      height: 64px;
      margin-bottom: 20px;
      stroke: var(--accent-color);
      opacity: 0.5;
    }

    .placeholder-content p {
      max-width: 400px;
      line-height: 1.6;
    }
    
    /* Sensors Dashboard Styles */
    .sensors-dashboard {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .sensors-current-values {
      display: flex;
      gap: 20px;
      justify-content: space-between;
    }
    
    .sensor-value-card {
      background-color: rgba(255, 255, 255, 0.07);
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sensor-value-card:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    .sensor-value-icon {
      background-color: rgba(56, 181, 147, 0.15);
      height: 50px;
      width: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sensor-value-icon svg {
      height: 24px;
      width: 24px;
      stroke: var(--accent-color);
    }
    
    .sensor-value-details {
      flex: 1;
    }
    
    .sensor-value-details h3 {
      margin: 0 0 5px 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }
    
    .sensor-value-reading {
      font-size: 1.8rem;
      font-weight: 600;
      color: white;
    }
    
    .sensor-value-unit {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-left: 3px;
    }
    
    /* Temperature Chart Styles */
    .temperature-chart-container {
      background-color: rgba(255, 255, 255, 0.07);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
      color: var(--accent-color);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    #temperature-chart {
      width: 100%;
      height: 300px;
      position: relative;
    }
    
    .sensors-stats {
      display: flex;
      gap: 20px;
      justify-content: space-between;
    }
    
    .sensor-stat-card {
      background-color: rgba(255, 255, 255, 0.07);
      flex: 1;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sensor-stat-card h4 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sensor-stat-values {
      display: flex;
      justify-content: space-between;
    }
    
    .sensor-stat-values-two {
      justify-content: space-around;
      max-width: 80%;
      margin: 0 auto;
    }
    
    .sensor-stat-value {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 3px;
    }
    
    .stat-value {
      font-size: 1rem;
      font-weight: 600;
      color: white;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .sensors-current-values {
        flex-direction: column;
        gap: 15px;
      }
      
      .sensors-stats {
        flex-direction: column;
        gap: 15px;
      }
      
      #temperature-chart {
        height: 250px;
      }
    }

    /* Apply button styles */
    .control-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 10px;
      margin-left: auto; /* Push to the right */
      display: block; /* Ensure it takes full width of its container */
    }
    
    .control-button:hover {
      background-color: rgba(56, 181, 147, 0.8);
      transform: translateY(-2px);
    }
    
    /* Apply the same positioning to the Automatic Schedule apply button */
    .apply-schedule-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 10px;
      margin-left: auto; /* Push to the right */
      display: block; /* Ensure it takes full width of its container */
    }
    
    .apply-schedule-button:hover {
      background-color: rgba(56, 181, 147, 0.8);
      transform: translateY(-2px);
    }

    /* Apply button states */
    .control-button.applying {
      background-color: #2a9678;
      pointer-events: none;
      position: relative;
      overflow: hidden;
    }
    
    .control-button.applying::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      100% {
        left: 100%;
      }
    }
    
    /* Toast notification */
    .settings-toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      background-color: #1e1e1e;
      border-left: 5px solid var(--accent-color);
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateX(120%);
      transition: transform 0.3s ease-out;
      z-index: 1000;
    }
    
    .settings-toast.show {
      transform: translateX(0);
    }
    
    .settings-toast-icon {
      margin-right: 12px;
      width: 24px;
      height: 24px;
    }
    
    .settings-toast-icon svg {
      width: 100%;
      height: 100%;
      stroke: var(--accent-color);
    }
    
    .settings-toast-content {
      color: white;
      font-weight: 500;
    }

    /* Apply the same button styles to the schedule apply button - removing previous declaration */
    .apply-schedule-button.applying {
      background-color: #2a9678;
      pointer-events: none;
      position: relative;
      overflow: hidden;
    }
    
    .apply-schedule-button.applying::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 1.5s infinite;
    }

    /* Schedule controlled styles */
    .schedule-controlled {
      position: relative;
      opacity: 0.8;
    }

    .schedule-controlled::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      pointer-events: none;
    }

    .schedule-indicator {
      display: inline-flex;
      align-items: center;
      margin-left: 8px;
      color: var(--accent-color);
    }

    .schedule-indicator svg {
      height: 14px;
      width: 14px;
    }

    .control-toggle input:disabled + .control-toggle-slider {
      background-color: rgba(255, 255, 255, 0.1);
      cursor: not-allowed;
    }

    .control-toggle input:disabled:checked + .control-toggle-slider {
      background-color: rgba(56, 181, 147, 0.5);
    }

    .parameter-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .parameter-section-title {
      margin: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    /* Add the CSS for the simpler parameter sections */
    .simple-parameter-section {
      padding: 15px;
    }

    /* Control Sections Styles */
    .control-sections {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .control-section {
      background-color: rgba(35, 35, 35, 0.9);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
      transition: all 0.3s ease;
      border-left: 3px solid var(--accent-color);
      position: relative;
      overflow: hidden;
    }
    
    .control-section:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
      background-color: rgba(40, 40, 40, 0.9);
    }
    
    /* Last section doesn't need bottom margin */
    .control-section:last-child {
      margin-bottom: 0;
    }
    
    .control-section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .control-section-header::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-color), rgba(56, 181, 147, 0.3));
      border-radius: 3px;
    }
    
    .control-section-icon {
      background-color: rgba(56, 181, 147, 0.15);
      height: 40px;
      width: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }
    
    .control-section:hover .control-section-icon {
      transform: rotate(15deg);
      background-color: rgba(56, 181, 147, 0.25);
    }
    
    .control-section-icon svg {
      height: 20px;
      width: 20px;
      stroke: var(--accent-color);
      transition: all 0.3s ease;
    }
    
    .control-section:hover .control-section-icon svg {
      stroke-width: 2.2;
    }
    
    .control-section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
      margin: 0;
      transition: all 0.3s ease;
    }
    
    .control-section:hover .control-section-title {
      color: var(--accent-color);
    }
    
    .control-subsections {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .control-subsection {
      background-color: rgba(40, 40, 40, 0.9);
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      border-left: 2px solid rgba(56, 181, 147, 0.4);
    }
    
    .control-subsection:hover {
      background-color: rgba(45, 45, 45, 0.9);
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.25);
      transform: translateY(-2px);
    }
    
    .control-subsection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .control-subsection-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: white;
      margin: 0;
      transition: color 0.3s ease;
    }
    
    .control-subsection:hover .control-subsection-title {
      color: var(--accent-color);
    }
    
    .control-toggle {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 26px;
    }
    
    .control-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .control-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 34px;
      transition: .4s;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .control-toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .4s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .control-toggle input:checked + .control-toggle-slider {
      background-color: var(--accent-color);
    }
    
    .control-toggle input:checked + .control-toggle-slider:before {
      transform: translateX(26px);
    }
    
    .control-content {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    
    .control-slider-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .control-slider-value {
      font-weight: 500;
      color: white;
      background-color: rgba(56, 181, 147, 0.15);
      padding: 3px 8px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .control-slider-group:hover .control-slider-label {
      color: white;
    }
    
    .control-slider-group:hover .control-slider-value {
      background-color: rgba(56, 181, 147, 0.25);
    }
    
    .control-slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .control-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .control-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    .control-schedule-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .control-time-input {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 10px 12px;
      color: white;
      width: 100px;
      transition: all 0.2s ease;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .control-time-input:hover {
      border-color: rgba(56, 181, 147, 0.5);
    }
    
    .control-time-input:focus {
      outline: none;
      border-color: var(--accent-color);
      background-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 2px rgba(56, 181, 147, 0.3);
    }
    
    .control-schedule-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }
    
    .control-schedule-group:hover .control-schedule-label {
      color: white;
    }
    
    .control-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      align-self: flex-start;
      margin-top: 15px;
      min-width: 150px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .control-button:hover {
      background-color: rgba(56, 181, 147, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }
    
    .control-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    @media (max-width: 768px) {
      .control-schedule-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .control-time-input {
        width: 100%;
      }
    }

    /* Sensors Data Styles */
    .sensors-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      padding: 30px;
      text-align: center;
    }
    
    .sensors-empty-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.6;
    }
    
    .sensors-empty-text {
      color: rgba(255, 255, 255, 0.7);
      max-width: 400px;
      line-height: 1.6;
      margin-bottom: 25px;
    }
    
    /* Add Sensors Button */
    .add-sensors-button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .add-sensors-button:hover {
      background-color: rgba(56, 181, 147, 0.85);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    .add-sensors-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Sensors Grid */
    .sensors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 25px;
      min-height: 200px;
    }
    
    .sensors-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .sensors-grid-title {
      font-size: 1.4rem;
      color: white;
      margin: 0;
    }
    
    .sensor-card {
      background: rgba(35, 35, 35, 0.95);
      border-radius: 10px;
      padding: 20px;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-left: 3px solid var(--accent-color);
      cursor: move; /* Indicates item is draggable */
    }
    
    .sensor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      background: rgba(40, 40, 40, 0.95);
    }
    
    .sensor-card.dragging {
      opacity: 0.7;
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
    }
    
    .sensor-icon-container {
      background-color: rgba(56, 181, 147, 0.15);
      height: 56px;
      width: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .sensor-card:hover .sensor-icon-container {
      background-color: rgba(56, 181, 147, 0.25);
      transform: scale(1.05);
    }
    
    .sensor-icon {
      width: 28px;
      height: 28px;
      stroke: var(--accent-color);
      transition: all 0.3s ease;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .sensor-card:hover .sensor-icon {
      stroke-width: 2.2;
    }
    
    .sensor-name {
      font-size: 1.1rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      margin: 0 0 5px 0;
      transition: color 0.3s ease;
    }
    
    .sensor-card:hover .sensor-name {
      color: white;
    }
    
    .sensor-value {
      font-size: 2.2rem;
      font-weight: 600;
      color: white;
      margin: 10px 0;
      transition: all 0.3s ease;
    }
    
    .sensor-card:hover .sensor-value {
      color: var(--accent-color);
    }
    
    .sensor-unit {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      margin-left: 5px;
    }
    
    .sensor-range {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 15px;
    }
    
    .sensor-actions {
      position: absolute;
      top: 15px;
      right: 15px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .sensor-card:hover .sensor-actions {
      opacity: 1;
    }
    
    .sensor-remove-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.7);
      transition: all 0.3s ease;
    }
    
    .sensor-remove-btn:hover {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
      transform: rotate(90deg);
    }
    
    /* Sensors Modal */
    .sensors-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .sensors-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .sensors-modal-container {
      background-color: #1e1e1e;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .sensors-modal.show .sensors-modal-container {
      transform: translateY(0);
    }
    
    .sensors-modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sensors-modal-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: white;
      margin: 0;
    }
    
    .sensors-modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .sensors-modal-close:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .sensors-modal-body {
      padding: 25px;
    }
    
    .sensors-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .sensor-option {
      background-color: rgba(35, 35, 35, 0.9);
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }
    
    .sensor-option:hover {
      background-color: rgba(40, 40, 40, 0.95);
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .sensor-option.selected {
      border-color: var(--accent-color);
      background-color: rgba(56, 181, 147, 0.1);
    }
    
    .sensor-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.8);
    }
    
    .sensor-option-checkbox {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: transparent;
      transition: all 0.3s ease;
    }
    
    .sensor-option.selected .sensor-option-checkbox {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }
    
    .sensor-option-icon {
      background-color: rgba(56, 181, 147, 0.15);
      height: 56px;
      width: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .sensor-option:hover .sensor-option-icon {
      background-color: rgba(56, 181, 147, 0.25);
    }
    
    .sensor-option-icon svg {
      width: 28px;
      height: 28px;
      stroke: var(--accent-color);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .sensor-option-name {
      font-size: 1.1rem;
      font-weight: 500;
      color: white;
      margin-bottom: 5px;
    }
    
    .sensor-option-desc {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.4;
    }
    
    .sensors-modal-footer {
      padding: 20px 25px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .modal-btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.8);
    }
    
    .modal-btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .modal-btn-primary {
      background: var(--accent-color);
      border: none;
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .modal-btn-primary:hover {
      background: rgba(56, 181, 147, 0.85);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }
    
    .modal-btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    /* Drag-and-drop placeholder/ghost */
    .sensor-card-ghost {
      background-color: rgba(56, 181, 147, 0.1);
      border: 2px dashed rgba(56, 181, 147, 0.5);
      border-radius: 10px;
    }
    
    /* Responsive design for sensors */
    @media (max-width: 768px) {
      .sensors-grid {
        grid-template-columns: 1fr;
      }
      
      .sensors-list {
        grid-template-columns: 1fr;
      }
    }

    .sensor-option-icon-svg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sensor-option-icon-svg svg {
      width: 28px;
      height: 28px;
      stroke: var(--accent-color);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(56, 181, 147, 0.7);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(56, 181, 147, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(56, 181, 147, 0);
      }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <header class="header">
      <div class="header__container">
        <a href="index.html" class="header__logo logo">Waraf</a>
        <div class="header__navigation">
          <div class="header__menu menu">
            <nav class="menu__body">
              <ul class="menu__list">
                <li class="menu__item"><a href="index.html" class="menu__link">Home</a></li>
                <li class="menu__item"><a href="about.html" class="menu__link">About</a></li>
                <li class="menu__item"><a href="services.html" class="menu__link">Solutions</a></li>
                <li class="menu__item"><a href="products.html" class="menu__link">Products</a></li>
                <li class="menu__item"><a href="contact.html" class="menu__link">Contact</a></li>
              </ul>
              <div class="user-dropdown" id="user-dropdown" style="display: none;">
                <div class="user-button">
                  <div class="user-avatar" id="user-avatar">U</div>
                </div>
                <div class="user-menu" id="user-menu">
                  <a href="dashboard.html" class="user-menu-item">Dashboard</a>
                  <div class="user-menu-divider"></div>
                  <a href="#" class="user-menu-item" id="logout-button">Log Out</a>
                </div>
              </div>
              <a href="#" class="actions-header__button" id="login-button">Login</a>
            </nav>
          </div>
          <div class="header__actions actions-header">
            <button type="button" class="menu__icon icon-menu"><span></span></button>
          </div>
        </div>
      </div>
    </header>
    <main class="page page__dashboard">
      <section class="dashboard">
        <div class="dashboard__container">
          <div class="product-details-header">
            <div class="product-details-title">
              <h1><strong>testPrototype</strong></h1>
              <span>DEVELOPER MODE</span>
            </div>
            <button id="back-to-dashboard" class="back-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
              Back to Dashboard
            </button>
          </div>

          <div class="product-details-nav">
            <div class="product-details-nav-item active" data-section="sensors">Sensors Data</div>
            <div class="product-details-nav-item" data-section="light">Control</div>
            <div class="product-details-nav-item" data-section="dispensers">Solar Power</div>
            <div class="product-details-nav-item" data-section="live-stream">Live Stream</div>
          </div>

          <div class="product-details-content">
            <div id="sensors-section" class="product-details-section active">
              <!-- Sensors dashboard with empty state and add button -->
              <div id="sensors-empty-state" class="sensors-empty-state">
                <svg class="sensors-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
                <p class="sensors-empty-text">
                  No sensors have been added yet. Add sensors to monitor various parameters of your hydroponic system.
                </p>
                <button id="add-sensors-button-empty" class="add-sensors-button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Add Sensors
                </button>
              </div>
              
              <!-- Sensors grid (hidden initially) -->
              <div id="sensors-grid-container" style="display: none;">
                <div class="sensors-grid-header">
                  <h2 class="sensors-grid-title">Sensors Dashboard</h2>
                  <button id="add-sensors-button" class="add-sensors-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Sensors
                  </button>
                </div>
                <div id="sensors-grid" class="sensors-grid">
                  <!-- Sensor cards will be added here dynamically -->
                </div>
              </div>
              
              <!-- Add Sensors Modal -->
              <div id="sensors-modal" class="sensors-modal">
                <div class="sensors-modal-container">
                  <div class="sensors-modal-header">
                    <h3 class="sensors-modal-title">Add Sensors</h3>
                    <button class="sensors-modal-close">&times;</button>
                  </div>
                  <div class="sensors-modal-body">
                    <div class="sensors-list" id="sensors-list">
                      <!-- Sensor options will be added here dynamically -->
                    </div>
                  </div>
                  <div class="sensors-modal-footer">
                    <button class="modal-btn modal-btn-outline" id="modal-cancel">Cancel</button>
                    <button class="modal-btn modal-btn-primary" id="modal-add-selected">Add Selected</button>
                  </div>
                </div>
              </div>
            </div>

            <div id="light-section" class="product-details-section">
              <div class="control-sections">
                <!-- Grow Lights Section -->
                <div class="control-section">
                  <div class="control-section-header">
                    <div class="control-section-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path>
                      </svg>
                    </div>
                    <h2 class="control-section-title">Grow Lights</h2>
                  </div>
                  
                  <div class="control-mode-selector">
                    <style>
                      .control-mode-selector {
                        display: flex;
                        background-color: rgba(25, 25, 25, 0.95);
                        border-radius: 8px;
                        margin-bottom: 20px;
                        overflow: hidden;
                      }
                      
                      .control-mode-button {
                        flex: 1;
                        padding: 12px;
                        text-align: center;
                        cursor: pointer;
                        border: none;
                        background-color: transparent;
                        color: rgba(255, 255, 255, 0.7);
                        font-weight: 500;
                        transition: all 0.3s ease;
                      }
                      
                      .control-mode-button.active {
                        background-color: rgba(56, 181, 147, 0.2);
                        color: white;
                        border-bottom: 3px solid var(--accent-color);
                      }
                      
                      .control-mode-button:hover:not(.active) {
                        background-color: rgba(50, 50, 50, 0.8);
                        color: white;
                      }
                      
                      .control-mode-content {
                        padding: 20px;
                        background-color: rgba(35, 35, 35, 0.95);
                        border-radius: 8px;
                        min-height: 150px;
                        display: none;
                      }
                      
                      .control-mode-content.active {
                        display: block;
                      }
                    </style>
                    <button class="control-mode-button active" id="manual-mode-button">Manual Control</button>
                    <button class="control-mode-button" id="automatic-mode-button">Automatic Schedule</button>
                  </div>
                  
                  <div id="manual-mode-content" class="control-mode-content active">
                    <style>
                      .light-toggles-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        margin-bottom: 20px;
                      }
                      
                      .light-toggle-item {
                        background-color: rgba(28, 28, 28, 0.9);
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                        border-left: 3px solid var(--accent-color);
                        transition: all 0.3s ease;
                      }
                      
                      .light-toggle-item:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
                        background-color: rgba(35, 35, 35, 0.9);
                      }
                      
                      .light-toggle-label {
                        font-size: 1.1rem;
                        font-weight: 500;
                        color: white;
                        transition: color 0.3s ease;
                      }
                      
                      .light-toggle-item:hover .light-toggle-label {
                        color: var(--accent-color);
                      }
                      
                      .light-toggle-section {
                        margin-bottom: 25px;
                        position: relative;
                      }
                      
                      .light-toggle-section-title {
                        color: var(--accent-color);
                        font-size: 1.1rem;
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        position: relative;
                        display: inline-block;
                      }
                      
                      .light-toggle-section-title::after {
                        content: '';
                        position: absolute;
                        bottom: -1px;
                        left: 0;
                        width: 50px;
                        height: 3px;
                        background-color: var(--accent-color);
                        border-radius: 2px;
                      }
                      
                      @media (max-width: 768px) {
                        .light-toggles-grid {
                          grid-template-columns: 1fr;
                        }
                      }
                    </style>
                    
                    <!-- Growing Layers Section -->
                    <div class="light-toggle-section">
                      <h3 class="light-toggle-section-title">Growing Layers</h3>
                      <div class="light-toggles-grid">
                        <!-- Layer 1 Toggle -->
                        <div class="light-toggle-item">
                          <span class="light-toggle-label">Layer 1</span>
                          <label class="control-toggle">
                            <input type="checkbox" class="light-toggle-input" data-layer="1">
                            <span class="control-toggle-slider"></span>
                          </label>
                        </div>
                        
                        <!-- Layer 2 Toggle -->
                        <div class="light-toggle-item">
                          <span class="light-toggle-label">Layer 2</span>
                          <label class="control-toggle">
                            <input type="checkbox" class="light-toggle-input" data-layer="2">
                            <span class="control-toggle-slider"></span>
                          </label>
                        </div>
                        
                        <!-- Layer 3 Toggle -->
                        <div class="light-toggle-item">
                          <span class="light-toggle-label">Layer 3</span>
                          <label class="control-toggle">
                            <input type="checkbox" class="light-toggle-input" data-layer="3">
                            <span class="control-toggle-slider"></span>
                          </label>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Specialized Lights Section -->
                    <div class="light-toggle-section">
                      <h3 class="light-toggle-section-title">Specialized Lights</h3>
                      <div class="light-toggles-grid">
                        <!-- Nursery Toggle -->
                        <div class="light-toggle-item">
                          <span class="light-toggle-label">Nursery</span>
                          <label class="control-toggle">
                            <input type="checkbox" class="light-toggle-input" data-layer="nursery">
                            <span class="control-toggle-slider"></span>
                          </label>
                        </div>
                        
                        <!-- Ultraviolet Toggle -->
                        <div class="light-toggle-item">
                          <span class="light-toggle-label">Ultraviolet</span>
                          <label class="control-toggle">
                            <input type="checkbox" class="light-toggle-input" data-layer="ultraviolet">
                            <span class="control-toggle-slider"></span>
                          </label>
                        </div>
                      </div>
                    </div>
                    
                    <button id="apply-light-settings" class="control-button" style="margin-top: 10px; min-width: 150px;">
                      <span style="position: relative; z-index: 2;">Apply Settings</span>
                    </button>
                    
                    <!-- Toast notification container -->
                    <div id="settings-toast" class="settings-toast">
                      <div class="settings-toast-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </div>
                      <div class="settings-toast-content">Settings applied successfully</div>
                    </div>
                    
                    <script>
                      document.addEventListener('DOMContentLoaded', function() {
                        const lightToggles = document.querySelectorAll('.light-toggle-input');
                        const applyButton = document.getElementById('apply-light-settings');
                        const settingsToast = document.getElementById('settings-toast');
                        
                        // Map toggle layers to relay numbers
                        const layerToRelayMap = {
                          '1': 'relay1',
                          '2': 'relay2',
                          '3': 'relay3',
                          'nursery': 'relay4',
                          'ultraviolet': 'relay10'
                        };
                        
                        // Map relay numbers back to toggle layers
                        const relayToLayerMap = {
                          'relay1': '1',
                          'relay2': '2',
                          'relay3': '3',
                          'relay4': 'nursery',
                          'relay10': 'ultraviolet'
                        };
                        
                        // Import Firebase modules
                        import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                            // Get Firebase instances from the global scope 
                            // (they're already initialized in the script at the bottom of the page)
                            const db = firebaseDB.getDatabase();
                            
                            // Track which light types have active schedules
                            const activeLightSchedules = {};
                            
                            // Load timer states first to check which lights are on schedules
                            const timersRef = firebaseDB.ref(db, 'timers');
                            firebaseDB.onValue(timersRef, (snapshot) => {
                              if (snapshot.exists()) {
                                const timerStates = snapshot.val();
                                console.log('Current timer states for disabling toggles:', timerStates);
                                
                                // Check each timer section and update activeLightSchedules
                                for (const section in timerStates) {
                                  const timer = timerStates[section];
                                  // A timer is active if it has the enabled property set to true and has valid times
                                  activeLightSchedules[section] = timer.enabled && timer.turnon && timer.turnoff;
                                }
                                
                                // Now update manual toggle button states based on schedules
                                lightToggles.forEach(toggle => {
                                  const layer = toggle.getAttribute('data-layer');
                                  
                                  // Check if this layer has an active schedule
                                  let isScheduleActive = false;
                                  if (layer === '1' || layer === '2' || layer === '3') {
                                    // Growing layers 1-3 are controlled by the 'layers' schedule
                                    isScheduleActive = activeLightSchedules['layers'] || false;
                                  } else {
                                    // Nursery and Ultraviolet have their own schedules
                                    isScheduleActive = activeLightSchedules[layer] || false;
                                  }
                                  
                                  // Disable manual toggle if there's an active schedule
                                  if (isScheduleActive) {
                                    toggle.disabled = true;
                                    // Add visual indication that it's controlled by a schedule
                                    const toggleItem = toggle.closest('.light-toggle-item');
                                    if (toggleItem) {
                                      toggleItem.classList.add('schedule-controlled');
                                      // Add a small schedule indicator if not already present
                                      if (!toggleItem.querySelector('.schedule-indicator')) {
                                        const indicator = document.createElement('div');
                                        indicator.className = 'schedule-indicator';
                                        indicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
                                        indicator.title = "Controlled by schedule";
                                        toggleItem.querySelector('.light-toggle-label').appendChild(indicator);
                                      }
                                    }
                                  } else {
                                    toggle.disabled = false;
                                    // Remove schedule control indicators
                                    const toggleItem = toggle.closest('.light-toggle-item');
                                    if (toggleItem) {
                                      toggleItem.classList.remove('schedule-controlled');
                                      const indicator = toggleItem.querySelector('.schedule-indicator');
                                      if (indicator) {
                                        indicator.remove();
                                      }
                                    }
                                  }
                                });
                                
                                // Load relay states after processing timer states
                                loadRelayStates();
                              } else {
                                // If no timer data, just load relay states directly
                                loadRelayStates();
                              }
                            });
                            
                            // Function to load relay states
                            function loadRelayStates() {
                              const relaysRef = firebaseDB.ref(db, 'relays');
                              firebaseDB.onValue(relaysRef, (snapshot) => {
                                if (snapshot.exists()) {
                                  const relayStates = snapshot.val();
                                  console.log('Current relay states:', relayStates);
                                  
                                  // Update toggle states based on relay values
                                  lightToggles.forEach(toggle => {
                                    const layer = toggle.getAttribute('data-layer');
                                    const relayKey = layerToRelayMap[layer];
                                    if (relayKey && relayStates[relayKey] !== undefined) {
                                      toggle.checked = relayStates[relayKey];
                                    }
                                  });
                                }
                              });
                            }
                            
                            // Apply button click handler
                            if (applyButton) {
                              applyButton.addEventListener('click', function() {
                                // Collect the state of all toggles and map to relay structure
                                const relayUpdates = {};
                                
                                lightToggles.forEach(toggle => {
                                  // Only include toggles that aren't disabled (not on a schedule)
                                  if (!toggle.disabled) {
                                    const layer = toggle.getAttribute('data-layer');
                                    const relayKey = layerToRelayMap[layer];
                                    if (relayKey) {
                                      relayUpdates[relayKey] = toggle.checked;
                                    }
                                  }
                                });
                                
                                console.log('Updating relay states:', relayUpdates);
                                
                                // Update Firebase with the new relay states
                                applyButton.classList.add('applying');
                                
                                // Write updates to Firebase
                                firebaseDB.update(firebaseDB.ref(db, 'relays'), relayUpdates)
                                  .then(() => {
                                    console.log('Relay states updated successfully');
                                    
                                    // Show success notification
                                    settingsToast.classList.add('show');
                                    applyButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      settingsToast.classList.remove('show');
                                    }, 3000);
                                  })
                                  .catch((error) => {
                                    console.error('Error updating relay states:', error);
                                    
                                    // Show error notification
                                    settingsToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                      '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                                    settingsToast.querySelector('.settings-toast-content').textContent = 'Error: Failed to apply settings';
                                    settingsToast.style.borderLeftColor = '#FF6B6B';
                                    settingsToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                                    settingsToast.classList.add('show');
                                    applyButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      // Reset toast styles for next time
                                      settingsToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                        '<polyline points="20 6 9 17 4 12"></polyline>';
                                      settingsToast.querySelector('.settings-toast-content').textContent = 'Settings applied successfully';
                                      settingsToast.style.borderLeftColor = 'var(--accent-color)';
                                      settingsToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                                      settingsToast.classList.remove('show');
                                    }, 3000);
                                  });
                              });
                            }
                          });
                        });
                      });
                    </script>
                  </div>
                  
                  <div id="automatic-mode-content" class="control-mode-content">
                    <style>
                      .schedule-sections {
                        display: flex;
                        flex-direction: column;
                        gap: 25px;
                      }
                      
                      .schedule-section {
                        background-color: rgba(28, 28, 28, 0.9);
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                      }
                      
                      .schedule-section:hover {
                        background-color: rgba(32, 32, 32, 0.9);
                      }
                      
                      .schedule-section::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 3px;
                        height: 100%;
                        background-color: var(--accent-color);
                      }
                      
                      .schedule-section-title {
                        color: var(--accent-color);
                        font-size: 1.1rem;
                        margin: 0 0 15px 0;
                        padding-bottom: 10px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        position: relative;
                        display: inline-block;
                      }
                      
                      .schedule-section-title::after {
                        content: '';
                        position: absolute;
                        bottom: -1px;
                        left: 0;
                        width: 50px;
                        height: 3px;
                        background-color: var(--accent-color);
                        border-radius: 2px;
                      }
                      
                      .time-settings {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 15px;
                      }
                      
                      .schedule-item {
                        background-color: rgba(22, 22, 22, 0.95);
                        border-radius: 8px;
                        padding: 18px;
                        flex: 1;
                        min-width: 250px;
                        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
                        transition: all 0.3s ease;
                        border-left: 3px solid rgba(56, 181, 147, 0.5);
                      }
                      
                      .schedule-item:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
                        background-color: rgba(26, 26, 26, 0.95);
                      }
                      
                      .schedule-item-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                      }
                      
                      .schedule-item-name {
                        font-size: 1rem;
                        font-weight: 500;
                        color: white;
                        margin: 0;
                      }
                      
                      .schedule-enabled {
                        position: relative;
                        display: inline-block;
                        width: 52px;
                        height: 26px;
                      }
                      
                      .schedule-enabled input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                      }
                      
                      .schedule-enabled-slider {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(255, 255, 255, 0.2);
                        border-radius: 34px;
                        transition: .4s;
                      }
                      
                      .schedule-enabled-slider:before {
                        position: absolute;
                        content: "";
                        height: 20px;
                        width: 20px;
                        left: 3px;
                        bottom: 3px;
                        background-color: white;
                        border-radius: 50%;
                        transition: .4s;
                      }
                      
                      .schedule-enabled input:checked + .schedule-enabled-slider {
                        background-color: var(--accent-color);
                      }
                      
                      .schedule-enabled input:checked + .schedule-enabled-slider:before {
                        transform: translateX(26px);
                      }
                      
                      .time-inputs {
                        display: flex;
                        gap: 15px;
                        align-items: center;
                      }
                      
                      .time-input-group {
                        flex: 1;
                      }
                      
                      .time-label {
                        display: block;
                        font-size: 0.8rem;
                        color: rgba(255, 255, 255, 0.7);
                        margin-bottom: 5px;
                      }
                      
                      .time-input {
                        width: 100%;
                        background-color: rgba(18, 18, 18, 0.95);
                        border: 1px solid rgba(255, 255, 255, 0.15);
                        border-radius: 6px;
                        padding: 10px 12px;
                        color: white;
                        font-size: 1.2rem;
                        font-weight: 500;
                        transition: all 0.2s ease;
                        text-align: center;
                        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
                      }
                      
                      .time-input:hover {
                        border-color: rgba(56, 181, 147, 0.5);
                      }
                      
                      .time-input:focus {
                        outline: none;
                        border-color: var(--accent-color);
                        background-color: rgba(25, 25, 25, 0.95);
                        box-shadow: 0 0 0 2px rgba(56, 181, 147, 0.3);
                      }
                      
                      .duration-display {
                        text-align: center;
                        font-size: 0.85rem;
                        color: rgba(255, 255, 255, 0.7);
                        margin-top: 10px;
                        font-style: italic;
                      }
                      
                      .duration-hours {
                        color: white;
                        font-weight: 500;
                      }
                      
                      .apply-schedule-button {
                        background-color: var(--accent-color);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.3s ease;
                        align-self: flex-start;
                        margin-top: 15px;
                        min-width: 150px;
                        position: relative;
                        overflow: hidden;
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
                      }
                      
                      .apply-schedule-button:hover {
                        background-color: rgba(56, 181, 147, 0.8);
                        transform: translateY(-2px);
                        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
                      }
                      
                      .apply-schedule-button:active {
                        transform: translateY(1px);
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                      }
                      
                      @media (max-width: 768px) {
                        .time-inputs {
                          flex-direction: column;
                          align-items: flex-start;
                          gap: 10px;
                        }
                        
                        .time-input-group {
                          width: 100%;
                        }
                      }
                    </style>
                    
                    <div class="schedule-sections">
                      <!-- Growing Layers Schedule Section -->
                      <div class="schedule-section">
                        <h3 class="schedule-section-title">Growing Layers Schedule</h3>
                        <div class="time-settings">
                          <!-- All Layers Combined Schedule -->
                          <div class="schedule-item">
                            <div class="schedule-item-header">
                              <h4 class="schedule-item-name">All Growing Layers (1, 2, 3)</h4>
                              <label class="schedule-enabled">
                                <input type="checkbox" class="schedule-enabled-input" data-schedule="layers" checked>
                                <span class="schedule-enabled-slider"></span>
                              </label>
                            </div>
                            <div class="time-inputs">
                              <div class="time-input-group">
                                <label class="time-label">Turn On</label>
                                <input type="time" class="time-input" value="06:00">
                              </div>
                              <div class="time-input-group">
                                <label class="time-label">Turn Off</label>
                                <input type="time" class="time-input" value="20:00">
                              </div>
                            </div>
                            <div class="duration-display">
                              Duration: <span class="duration-hours">14 hours</span> per day
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Specialized Lights Schedule Section -->
                      <div class="schedule-section">
                        <h3 class="schedule-section-title">Specialized Lights Schedule</h3>
                        <div class="time-settings">
                          <!-- Nursery Schedule -->
                          <div class="schedule-item">
                            <div class="schedule-item-header">
                              <h4 class="schedule-item-name">Nursery</h4>
                              <label class="schedule-enabled">
                                <input type="checkbox" class="schedule-enabled-input" data-schedule="nursery" checked>
                                <span class="schedule-enabled-slider"></span>
                              </label>
                            </div>
                            <div class="time-inputs">
                              <div class="time-input-group">
                                <label class="time-label">Turn On</label>
                                <input type="time" class="time-input" value="05:00">
                              </div>
                              <div class="time-input-group">
                                <label class="time-label">Turn Off</label>
                                <input type="time" class="time-input" value="21:00">
                              </div>
                            </div>
                            <div class="duration-display">
                              Duration: <span class="duration-hours">16 hours</span> per day
                            </div>
                          </div>
                          
                          <!-- Ultraviolet Schedule -->
                          <div class="schedule-item">
                            <div class="schedule-item-header">
                              <h4 class="schedule-item-name">Ultraviolet</h4>
                              <label class="schedule-enabled">
                                <input type="checkbox" class="schedule-enabled-input" data-schedule="ultraviolet" checked>
                                <span class="schedule-enabled-slider"></span>
                              </label>
                            </div>
                            <div class="time-inputs">
                              <div class="time-input-group">
                                <label class="time-label">Turn On</label>
                                <input type="time" class="time-input" value="10:00">
                              </div>
                              <div class="time-input-group">
                                <label class="time-label">Turn Off</label>
                                <input type="time" class="time-input" value="14:00">
                              </div>
                            </div>
                            <div class="duration-display">
                              Duration: <span class="duration-hours">4 hours</span> per day
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <button class="apply-schedule-button" id="apply-schedule-settings">Apply Settings</button>
                      
                      <!-- Toast notification container for schedule -->
                      <div id="schedule-toast" class="settings-toast">
                        <div class="settings-toast-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        </div>
                        <div class="settings-toast-content">Schedule settings applied successfully</div>
                      </div>
                    </div>
                    
                    <script>
                      // Function to calculate duration between two times
                      function calculateDuration(startTime, endTime) {
                        // Parse the times to get hours and minutes
                        const [startHours, startMinutes] = startTime.split(':').map(Number);
                        const [endHours, endMinutes] = endTime.split(':').map(Number);
                        
                        // Convert to minutes since midnight
                        const startTotalMinutes = startHours * 60 + startMinutes;
                        let endTotalMinutes = endHours * 60 + endMinutes;
                        
                        // Handle case where end time is on the next day (earlier time)
                        if (endTotalMinutes < startTotalMinutes) {
                          endTotalMinutes += 24 * 60; // Add 24 hours in minutes
                        }
                        
                        // Calculate difference in minutes
                        const durationMinutes = endTotalMinutes - startTotalMinutes;
                        
                        // Convert back to hours and minutes
                        const durationHours = Math.floor(durationMinutes / 60);
                        const remainingMinutes = durationMinutes % 60;
                        
                        // Format the result
                        if (remainingMinutes === 0) {
                          return `${durationHours} hours`;
                        } else {
                          return `${durationHours}h ${remainingMinutes}m`;
                        }
                      }
                      
                      // Function to update all durations
                      function updateAllDurations() {
                        // Get all schedule items
                        const scheduleItems = document.querySelectorAll('.schedule-item');
                        
                        scheduleItems.forEach(item => {
                          // Get the on and off time inputs
                          const timeInputs = item.querySelectorAll('.time-input');
                          if (timeInputs.length === 2) {
                            const onTime = timeInputs[0].value;
                            const offTime = timeInputs[1].value;
                            
                            // Calculate duration
                            const duration = calculateDuration(onTime, offTime);
                            
                            // Update the duration display
                            const durationElement = item.querySelector('.duration-hours');
                            if (durationElement) {
                              durationElement.textContent = duration;
                            }
                          }
                        });
                      }
                      
                      // Set up event listeners for all time inputs
                      document.addEventListener('DOMContentLoaded', function() {
                        const timeInputs = document.querySelectorAll('.time-input');
                        const applyScheduleButton = document.getElementById('apply-schedule-settings');
                        const scheduleToast = document.getElementById('schedule-toast');
                        
                        timeInputs.forEach(input => {
                          input.addEventListener('change', updateAllDurations);
                        });
                        
                        // Import Firebase modules
                        import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                            // Get Firebase instances from the global scope 
                            const db = firebaseDB.getDatabase();
                            
                            // Load initial timer states
                            const timersRef = firebaseDB.ref(db, 'timers');
                            firebaseDB.onValue(timersRef, (snapshot) => {
                              if (snapshot.exists()) {
                                const timerStates = snapshot.val();
                                console.log('Current timer states:', timerStates);
                                
                                // Update UI based on timer values
                                const scheduleItems = document.querySelectorAll('.schedule-item');
                                
                                scheduleItems.forEach(item => {
                                  const header = item.querySelector('.schedule-item-name');
                                  if (!header) return;
                                  
                                  const headerText = header.textContent.trim();
                                  const timeInputs = item.querySelectorAll('.time-input');
                                  const toggleInput = item.querySelector('.schedule-enabled-input');
                                  
                                  let section = null;
                                  if (headerText.includes('Growing Layers') || headerText.includes('All Growing Layers')) {
                                    section = 'layers';
                                  } else if (headerText === 'Nursery') {
                                    section = 'nursery';
                                  } else if (headerText === 'Ultraviolet') {
                                    section = 'ultraviolet';
                                  }
                                  
                                  if (section && timerStates[section]) {
                                    // Update time inputs
                                    if (timeInputs.length === 2 && timerStates[section].turnon && timerStates[section].turnoff) {
                                      timeInputs[0].value = timerStates[section].turnon;
                                      timeInputs[1].value = timerStates[section].turnoff;
                                    }
                                    
                                    // Update toggle state if it exists in Firebase
                                    if (toggleInput && timerStates[section].hasOwnProperty('enabled')) {
                                      toggleInput.checked = timerStates[section].enabled;
                                    }
                                  }
                                });
                                
                                // Update duration displays
                                updateAllDurations();
                              }
                            });
                            
                            // Apply Schedule Settings button functionality
                            if (applyScheduleButton && scheduleToast) {
                              applyScheduleButton.addEventListener('click', function() {
                                // Add applying style to show loading state
                                applyScheduleButton.classList.add('applying');
                                
                                // Collect schedule times from all inputs
                                const scheduleUpdates = {
                                  layers: {
                                    turnon: "",
                                    turnoff: "",
                                    enabled: false
                                  },
                                  nursery: {
                                    turnon: "",
                                    turnoff: "",
                                    enabled: false
                                  },
                                  ultraviolet: {
                                    turnon: "",
                                    turnoff: "",
                                    enabled: false
                                  }
                                };
                                
                                // Get all schedule items
                                const scheduleItems = document.querySelectorAll('.schedule-item');
                                
                                scheduleItems.forEach(item => {
                                  const header = item.querySelector('.schedule-item-name');
                                  if (!header) return;
                                  
                                  const headerText = header.textContent.trim();
                                  const timeInputs = item.querySelectorAll('.time-input');
                                  const toggleInput = item.querySelector('.schedule-enabled-input');
                                  const isEnabled = toggleInput ? toggleInput.checked : false;
                                  
                                  // Determine which section this item belongs to
                                  let section = null;
                                  if (headerText.includes('Growing Layers') || headerText.includes('All Growing Layers')) {
                                    section = 'layers';
                                  } else if (headerText === 'Nursery') {
                                    section = 'nursery';
                                  } else if (headerText === 'Ultraviolet') {
                                    section = 'ultraviolet';
                                  }
                                  
                                  if (section) {
                                    // Set the enabled state
                                    scheduleUpdates[section].enabled = isEnabled;
                                    
                                    // Only set time values if the toggle is enabled
                                    if (isEnabled && timeInputs.length === 2) {
                                      scheduleUpdates[section].turnon = timeInputs[0].value;
                                      scheduleUpdates[section].turnoff = timeInputs[1].value;
                                    } else {
                                      // If disabled, set empty values
                                      scheduleUpdates[section].turnon = "";
                                      scheduleUpdates[section].turnoff = "";
                                    }
                                  }
                                });
                                
                                console.log('Updating timer settings:', scheduleUpdates);
                                
                                // Update Firebase with the schedule settings
                                firebaseDB.update(firebaseDB.ref(db, 'timers'), scheduleUpdates)
                                  .then(() => {
                                    console.log('Timer settings updated successfully');
                                    
                                    // Show success notification
                                    scheduleToast.classList.add('show');
                                    applyScheduleButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      scheduleToast.classList.remove('show');
                                    }, 3000);
                                  })
                                  .catch((error) => {
                                    console.error('Error updating timer settings:', error);
                                    
                                    // Show error notification
                                    scheduleToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                      '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                                    scheduleToast.querySelector('.settings-toast-content').textContent = 'Error: Failed to apply schedule';
                                    scheduleToast.style.borderLeftColor = '#FF6B6B';
                                    scheduleToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                                    scheduleToast.classList.add('show');
                                    applyScheduleButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      // Reset toast styles for next time
                                      scheduleToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                        '<polyline points="20 6 9 17 4 12"></polyline>';
                                      scheduleToast.querySelector('.settings-toast-content').textContent = 'Schedule settings applied successfully';
                                      scheduleToast.style.borderLeftColor = 'var(--accent-color)';
                                      scheduleToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                                      scheduleToast.classList.remove('show');
                                    }, 3000);
                                  });
                              });
                            }
                          });
                        });
                        
                        // Calculate initial durations
                        updateAllDurations();
                      });
                    </script>
                  </div>
                </div>
                
                <style>
                  /* Apply the same button styles to the schedule apply button - removing previous declaration */
                  .apply-schedule-button.applying {
                    background-color: #2a9678;
                    pointer-events: none;
                    position: relative;
                    overflow: hidden;
                  }
                  
                  .apply-schedule-button.applying::after {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    animation: shimmer 1.5s infinite;
                  }
                </style>
                
                <script>
                  // JavaScript to handle mode switching
                  document.addEventListener('DOMContentLoaded', function() {
                    const manualButton = document.getElementById('manual-mode-button');
                    const automaticButton = document.getElementById('automatic-mode-button');
                    const manualContent = document.getElementById('manual-mode-content');
                    const automaticContent = document.getElementById('automatic-mode-content');
                    
                    manualButton.addEventListener('click', function() {
                      manualButton.classList.add('active');
                      automaticButton.classList.remove('active');
                      manualContent.classList.add('active');
                      automaticContent.classList.remove('active');
                    });
                    
                    automaticButton.addEventListener('click', function() {
                      automaticButton.classList.add('active');
                      manualButton.classList.remove('active');
                      automaticContent.classList.add('active');
                      manualContent.classList.remove('active');
                    });
                  });
                </script>
                
                <!-- Main Pump Section -->
                <div class="control-section">
                  <div class="control-section-header">
                    <div class="control-section-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
                      </svg>
                    </div>
                    <h2 class="control-section-title">Main Pump</h2>
                  </div>
                  
                  <div id="main-pump-content" style="padding: 20px; background-color: rgba(35, 35, 35, 0.95); border-radius: 8px; min-height: 150px;">
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; line-height: 1.6;">
                      Control the main water pump for your hydroponics system. This pump is crucial for water circulation and nutrient delivery.
                    </p>
                    
                    <div class="main-pump-controls" style="display: flex; flex-direction: column; gap: 20px;">
                      <!-- Main Pump Toggle -->
                      <div style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--accent-color);">
                        <span style="font-size: 1.1rem; font-weight: 500; color: white;">Main Pump Status</span>
                        <label class="control-toggle">
                          <input type="checkbox" id="main-pump-toggle">
                          <span class="control-toggle-slider"></span>
                        </label>
                      </div>
                      
                      <!-- Password Field -->
                      <div style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: block; color: white; font-weight: 500; margin-bottom: 10px;">
                          Security Password
                          <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-left: 5px;">(Required to change pump status)</span>
                        </label>
                        <div style="display: flex; align-items: center;">
                          <input type="password" id="pump-password-input" placeholder="Enter password" style="flex: 1; background-color: rgba(18, 18, 18, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); padding: 10px 12px; border-radius: 6px; color: white; font-size: 1.1rem;">
                        </div>
                      </div>
                      
                      <button id="apply-pump-settings" class="control-button" style="margin-top: 15px; align-self: flex-end;">
                        <span style="position: relative; z-index: 2;">Apply Settings</span>
                      </button>
                    </div>
                    
                    <!-- Toast notification for pump settings -->
                    <div id="pump-toast" class="settings-toast">
                      <div class="settings-toast-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </div>
                      <div class="settings-toast-content">Pump settings applied successfully</div>
                    </div>
                    
                    <script>
                      document.addEventListener('DOMContentLoaded', function() {
                        const mainPumpToggle = document.getElementById('main-pump-toggle');
                        const pumpPasswordInput = document.getElementById('pump-password-input');
                        const applyButton = document.getElementById('apply-pump-settings');
                        const pumpToast = document.getElementById('pump-toast');
                        
                        // Define the correct password
                        const correctPassword = "121";
                        
                        // Load initial pump status from Firebase
                        function loadPumpStatus() {
                          // Import Firebase modules
                          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                            import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                              // Get Firebase instances
                              const db = firebaseDB.getDatabase();
                              
                              // Reference to the relay9 node
                              const relay9Ref = firebaseDB.ref(db, 'relays/relay9');
                              
                              // Get current value
                              firebaseDB.onValue(relay9Ref, (snapshot) => {
                                if (snapshot.exists()) {
                                  const pumpStatus = snapshot.val();
                                  console.log('Current pump status:', pumpStatus);
                                  
                                  // Update toggle state
                                  mainPumpToggle.checked = pumpStatus;
                                }
                              });
                            });
                          });
                        }
                        
                        // Call the function to load initial values
                        loadPumpStatus();
                        
                        // Apply settings button click handler
                        if (applyButton) {
                          applyButton.addEventListener('click', function() {
                            // Get password value
                            const passwordValue = pumpPasswordInput.value.trim();
                            
                            // Verify password
                            if (passwordValue !== correctPassword) {
                              // Show error notification for incorrect password
                              pumpToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                              pumpToast.querySelector('.settings-toast-content').textContent = 'Error: Incorrect password';
                              pumpToast.style.borderLeftColor = '#FF6B6B';
                              pumpToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                              pumpToast.classList.add('show');
                              
                              // Clear password field
                              pumpPasswordInput.value = '';
                              
                              // Hide notification after 3 seconds
                              setTimeout(() => {
                                // Reset toast styles for next time
                                pumpToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                  '<polyline points="20 6 9 17 4 12"></polyline>';
                                pumpToast.querySelector('.settings-toast-content').textContent = 'Pump settings applied successfully';
                                pumpToast.style.borderLeftColor = 'var(--accent-color)';
                                pumpToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                                pumpToast.classList.remove('show');
                              }, 3000);
                              
                              return;
                            }
                            
                            // Get toggle state
                            const pumpState = mainPumpToggle.checked;
                            
                            // Import Firebase modules and update database
                            import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                              import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                                // Get Firebase instances
                                const db = firebaseDB.getDatabase();
                                
                                // Reference to the relay9 node
                                const relay9Ref = firebaseDB.ref(db, 'relays/relay9');
                                
                                // Show applying state
                                applyButton.classList.add('applying');
                                
                                // Update value in Firebase
                                firebaseDB.set(relay9Ref, pumpState)
                                  .then(() => {
                                    console.log('Pump status updated successfully:', pumpState);
                                    
                                    // Show success notification
                                    pumpToast.querySelector('.settings-toast-content').textContent = 
                                      pumpState ? 'Main pump turned ON successfully' : 'Main pump turned OFF successfully';
                                    pumpToast.classList.add('show');
                                    applyButton.classList.remove('applying');
                                    
                                    // Clear password field
                                    pumpPasswordInput.value = '';
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      pumpToast.classList.remove('show');
                                    }, 3000);
                                  })
                                  .catch((error) => {
                                    console.error('Error updating pump status:', error);
                                    
                                    // Show error notification
                                    pumpToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                      '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                                    pumpToast.querySelector('.settings-toast-content').textContent = 'Error: Failed to update pump status';
                                    pumpToast.style.borderLeftColor = '#FF6B6B';
                                    pumpToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                                    pumpToast.classList.add('show');
                                    applyButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      // Reset toast styles for next time
                                      pumpToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                        '<polyline points="20 6 9 17 4 12"></polyline>';
                                      pumpToast.querySelector('.settings-toast-content').textContent = 'Pump settings applied successfully';
                                      pumpToast.style.borderLeftColor = 'var(--accent-color)';
                                      pumpToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                                      pumpToast.classList.remove('show');
                                    }, 3000);
                                  });
                              });
                            });
                          });
                        }
                      });
                    </script>
                  </div>
                </div>
                
                <!-- Dispensers Section -->
                <div class="control-section">
                  <div class="control-section-header">
                    <div class="control-section-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 7v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        <path d="M7 9h10M10 12h4M7 15h10"></path>
                      </svg>
                    </div>
                    <h2 class="control-section-title">Dispensers</h2>
                  </div>
                  
                  <!-- Replace the dispensers-manual-content with a form for solution inputs -->
                  <div id="dispensers-manual-content" class="control-mode-content active" style="padding: 20px; background-color: rgba(35, 35, 35, 0.95); border-radius: 8px; min-height: 150px;">
                    <h3 style="color: var(--accent-color); margin-top: 0; margin-bottom: 20px; font-size: 1.2rem;">Nutrient Dispensers</h3>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; line-height: 1.6;">
                      Configure the amount of nutrients and pH adjusters to be dispensed into your hydroponic system.
                    </p>
                    
                    <div class="dispensers-form" style="display: flex; flex-direction: column; gap: 20px;">
                      <!-- Solution A Input -->
                      <div class="dispenser-input-group" style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: block; color: white; font-weight: 500; margin-bottom: 10px;">
                          Solution A
                          <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-left: 5px;">(Primary Nutrients)</span>
                        </label>
                        <div style="display: flex; align-items: center;">
                          <input type="number" id="solution-a-input" min="0" max="1000" placeholder="0" style="flex: 1; background-color: rgba(18, 18, 18, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); padding: 10px 12px; border-radius: 6px; color: white; font-size: 1.1rem;">
                          <span style="margin-left: 10px; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">mL</span>
                        </div>
                      </div>
                      
                      <!-- Solution B Input -->
                      <div class="dispenser-input-group" style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: block; color: white; font-weight: 500; margin-bottom: 10px;">
                          Solution B
                          <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-left: 5px;">(Secondary Nutrients)</span>
                        </label>
                        <div style="display: flex; align-items: center;">
                          <input type="number" id="solution-b-input" min="0" max="1000" placeholder="0" style="flex: 1; background-color: rgba(18, 18, 18, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); padding: 10px 12px; border-radius: 6px; color: white; font-size: 1.1rem;">
                          <span style="margin-left: 10px; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">mL</span>
                        </div>
                      </div>
                      
                      <!-- pH Down Input -->
                      <div class="dispenser-input-group" style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: block; color: white; font-weight: 500; margin-bottom: 10px;">
                          pH Down
                          <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-left: 5px;">(Acid Solution)</span>
                        </label>
                        <div style="display: flex; align-items: center;">
                          <input type="number" id="ph-down-input" min="0" max="1000" placeholder="0" style="flex: 1; background-color: rgba(18, 18, 18, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); padding: 10px 12px; border-radius: 6px; color: white; font-size: 1.1rem;">
                          <span style="margin-left: 10px; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">mL</span>
                        </div>
                      </div>
                      
                      <!-- Flow Rate Input -->
                      <div class="dispenser-input-group" style="background-color: rgba(28, 28, 28, 0.9); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
                        <label style="display: block; color: white; font-weight: 500; margin-bottom: 10px;">
                          Flow Rate
                          <span style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-left: 5px;">(Pump Speed)</span>
                        </label>
                        <div style="display: flex; align-items: center;">
                          <input type="number" id="flow-rate-input" min="0.1" max="50" step="0.1" placeholder="0" style="flex: 1; background-color: rgba(18, 18, 18, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); padding: 10px 12px; border-radius: 6px; color: white; font-size: 1.1rem;">
                          <span style="margin-left: 10px; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">mL/s</span>
                        </div>
                      </div>
                      
                      <button id="apply-dispenser-settings" class="control-button" style="margin-top: 15px; align-self: flex-end;">
                        <span style="position: relative; z-index: 2;">Apply Settings</span>
                      </button>
                    </div>
                    
                    <!-- Toast notification for dispensers -->
                    <div id="dispensers-toast" class="settings-toast">
                      <div class="settings-toast-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </div>
                      <div class="settings-toast-content">Dispenser settings applied successfully</div>
                    </div>
                    
                    <script>
                      document.addEventListener('DOMContentLoaded', function() {
                        const solutionAInput = document.getElementById('solution-a-input');
                        const solutionBInput = document.getElementById('solution-b-input');
                        const phDownInput = document.getElementById('ph-down-input');
                        const flowRateInput = document.getElementById('flow-rate-input');
                        const applyButton = document.getElementById('apply-dispenser-settings');
                        const dispensersToast = document.getElementById('dispensers-toast');
                        
                        // Load initial values from Firebase
                        function loadDispenserSettings() {
                          // Import Firebase modules
                          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                            import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                              // Get Firebase instances
                              const db = firebaseDB.getDatabase();
                              
                              // Reference to the dispensers node
                              const dispensersRef = firebaseDB.ref(db, 'dispensers');
                              
                              // Get current values
                              firebaseDB.onValue(dispensersRef, (snapshot) => {
                                if (snapshot.exists()) {
                                  const dispensersData = snapshot.val();
                                  console.log('Current dispenser settings:', dispensersData);
                                  
                                  // Update input fields with values from Firebase (if they exist)
                                  if (dispensersData.solutionA && dispensersData.solutionA.amount) {
                                    solutionAInput.value = dispensersData.solutionA.amount;
                                  }
                                  
                                  if (dispensersData.solutionB && dispensersData.solutionB.amount) {
                                    solutionBInput.value = dispensersData.solutionB.amount;
                                  }
                                  
                                  if (dispensersData.pHdown && dispensersData.pHdown.amount) {
                                    phDownInput.value = dispensersData.pHdown.amount;
                                  }
                                  
                                  if (dispensersData.flowRate) {
                                    flowRateInput.value = dispensersData.flowRate;
                                  }
                                }
                              });
                            });
                          });
                        }
                        
                        // Call the function to load initial values
                        loadDispenserSettings();
                        
                        // Apply settings button click handler
                        if (applyButton) {
                          applyButton.addEventListener('click', function() {
                            // Get values from inputs
                            const solutionAValue = solutionAInput.value.trim();
                            const solutionBValue = solutionBInput.value.trim();
                            const phDownValue = phDownInput.value.trim();
                            const flowRateValue = flowRateInput.value.trim();
                            
                            // Calculate time for each solution if flow rate is provided
                            // Time = Amount (mL) / Flow Rate (mL/s) = seconds
                            let solutionATime = "";
                            let solutionBTime = "";
                            let phDownTime = "";
                            
                            if (flowRateValue && parseFloat(flowRateValue) > 0) {
                              const flowRate = parseFloat(flowRateValue);
                              
                              if (solutionAValue && parseFloat(solutionAValue) > 0) {
                                solutionATime = (parseFloat(solutionAValue) / flowRate).toFixed(1);
                              }
                              
                              if (solutionBValue && parseFloat(solutionBValue) > 0) {
                                solutionBTime = (parseFloat(solutionBValue) / flowRate).toFixed(1);
                              }
                              
                              if (phDownValue && parseFloat(phDownValue) > 0) {
                                phDownTime = (parseFloat(phDownValue) / flowRate).toFixed(1);
                              }
                            }
                            
                            // Import Firebase modules and update database
                            import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                              import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                                // Get Firebase instances
                                const db = firebaseDB.getDatabase();
                                
                                // Reference to the dispensers node
                                const dispensersRef = firebaseDB.ref(db, 'dispensers');
                                
                                // Prepare data structure for Firebase
                                const dispenserData = {
                                  flowRate: flowRateValue,
                                  pHdown: {
                                    amount: phDownValue,
                                    time: phDownTime
                                  },
                                  solutionA: {
                                    amount: solutionAValue,
                                    time: solutionATime
                                  },
                                  solutionB: {
                                    amount: solutionBValue,
                                    time: solutionBTime
                                  }
                                };
                                
                                console.log('Updating dispenser settings:', dispenserData);
                                
                                // Show applying state
                                applyButton.classList.add('applying');
                                
                                // Update values in Firebase
                                firebaseDB.set(dispensersRef, dispenserData)
                                  .then(() => {
                                    console.log('Dispenser settings updated successfully');
                                    
                                    // Show success notification
                                    dispensersToast.classList.add('show');
                                    
                                    // Now handle the relay control for each solution
                                    controlDispenserRelays(firebaseDB, db, solutionATime, solutionBTime, phDownTime);
                                    
                                    // Keep the applying state until all dispensing operations are complete
                                    // The applying state will be removed by the controlDispenserRelays function
                                  })
                                  .catch((error) => {
                                    console.error('Error updating dispenser settings:', error);
                                    
                                    // Show error notification
                                    dispensersToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                      '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                                    dispensersToast.querySelector('.settings-toast-content').textContent = 'Error: Failed to apply dispenser settings';
                                    dispensersToast.style.borderLeftColor = '#FF6B6B';
                                    dispensersToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                                    dispensersToast.classList.add('show');
                                    applyButton.classList.remove('applying');
                                    
                                    // Hide notification after 3 seconds
                                    setTimeout(() => {
                                      // Reset toast styles for next time
                                      dispensersToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                        '<polyline points="20 6 9 17 4 12"></polyline>';
                                      dispensersToast.querySelector('.settings-toast-content').textContent = 'Dispenser settings applied successfully';
                                      dispensersToast.style.borderLeftColor = 'var(--accent-color)';
                                      dispensersToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                                      dispensersToast.classList.remove('show');
                                    }, 3000);
                                  });
                              });
                            });
                          });
                        }
                        
                        // Function to control dispenser relays based on calculated times
                        function controlDispenserRelays(firebaseDB, db, solutionATime, solutionBTime, phDownTime) {
                          // Convert time strings to numbers and ensure they're valid
                          const solutionASeconds = parseFloat(solutionATime) || 0;
                          const solutionBSeconds = parseFloat(solutionBTime) || 0;
                          const phDownSeconds = parseFloat(phDownTime) || 0;
                          
                          // Reference to the relays node
                          const relaysRef = firebaseDB.ref(db, 'relays');
                          
                          // Get current relay states first
                          firebaseDB.get(relaysRef).then((snapshot) => {
                            if (snapshot.exists()) {
                              const relayStates = snapshot.val();
                              console.log('Current relay states before dispensing:', relayStates);
                              
                              // Process solution A (relay5) if time > 0
                              if (solutionASeconds > 0) {
                                processSolutionRelay(firebaseDB, db, 'relay5', solutionASeconds, 'Solution A');
                              }
                              
                              // Process solution B (relay6) if time > 0
                              if (solutionBSeconds > 0) {
                                processSolutionRelay(firebaseDB, db, 'relay6', solutionBSeconds, 'Solution B');
                              }
                              
                              // Process pH down (relay7) if time > 0
                              if (phDownSeconds > 0) {
                                processSolutionRelay(firebaseDB, db, 'relay7', phDownSeconds, 'pH Down');
                              }
                              
                              // If no solutions are being dispensed, remove applying state immediately
                              if (solutionASeconds <= 0 && solutionBSeconds <= 0 && phDownSeconds <= 0) {
                                document.getElementById('apply-dispenser-settings').classList.remove('applying');
                              }
                              
                              // Update the toast message to indicate dispensing is in progress
                              if (solutionASeconds > 0 || solutionBSeconds > 0 || phDownSeconds > 0) {
                                updateDispensingStatus('Dispensing in progress...');
                              }
                            } else {
                              console.error('Relay states not found in Firebase');
                              document.getElementById('apply-dispenser-settings').classList.remove('applying');
                            }
                          }).catch(error => {
                            console.error('Error getting relay states:', error);
                            document.getElementById('apply-dispenser-settings').classList.remove('applying');
                          });
                        }
                        
                        // Helper function to process a single solution relay
                        function processSolutionRelay(firebaseDB, db, relayKey, durationSeconds, solutionName) {
                          console.log(`Starting ${solutionName} dispensing using ${relayKey} for ${durationSeconds} seconds`);
                          
                          // First turn on the relay
                          const relayUpdate = {};
                          relayUpdate[relayKey] = true;
                          
                          firebaseDB.update(firebaseDB.ref(db, 'relays'), relayUpdate)
                            .then(() => {
                              console.log(`${relayKey} turned ON for ${solutionName}`);
                              updateDispensingStatus(`Dispensing ${solutionName}... (${durationSeconds}s)`);
                              
                              // Set a timeout to turn off the relay after the specified duration
                              setTimeout(() => {
                                const relayOffUpdate = {};
                                relayOffUpdate[relayKey] = false;
                                
                                firebaseDB.update(firebaseDB.ref(db, 'relays'), relayOffUpdate)
                                  .then(() => {
                                    console.log(`${relayKey} turned OFF after dispensing ${solutionName}`);
                                    updateDispensingStatus(`${solutionName} dispensing complete`);
                                    
                                    // Check if this was the last relay to process
                                    checkIfDispensingComplete();
                                  })
                                  .catch(error => {
                                    console.error(`Error turning off ${relayKey} for ${solutionName}:`, error);
                                    updateDispensingStatus(`Error turning off ${solutionName} pump`, true);
                                    checkIfDispensingComplete();
                                  });
                              }, durationSeconds * 1000); // Convert seconds to milliseconds
                            })
                            .catch(error => {
                              console.error(`Error turning on ${relayKey} for ${solutionName}:`, error);
                              updateDispensingStatus(`Error activating ${solutionName} pump`, true);
                              checkIfDispensingComplete();
                            });
                        }
                        
                        // Track active dispensing operations
                        const activeDispensing = {
                          solutionA: false,
                          solutionB: false,
                          phDown: false
                        };
                        
                        // Function to update the dispensing status message
                        function updateDispensingStatus(message, isError = false) {
                          const dispensersToast = document.getElementById('dispensers-toast');
                          
                          if (isError) {
                            dispensersToast.querySelector('.settings-toast-icon svg').innerHTML = 
                              '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                            dispensersToast.style.borderLeftColor = '#FF6B6B';
                            dispensersToast.querySelector('.settings-toast-icon svg').style.stroke = '#FF6B6B';
                          } else {
                            dispensersToast.querySelector('.settings-toast-icon svg').innerHTML = 
                              '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 16v-4"></path><path d="M12 8h.01"></path>';
                            dispensersToast.style.borderLeftColor = 'var(--accent-color)';
                            dispensersToast.querySelector('.settings-toast-icon svg').style.stroke = 'var(--accent-color)';
                          }
                          
                          dispensersToast.querySelector('.settings-toast-content').textContent = message;
                          dispensersToast.classList.add('show');
                        }
                        
                        // Function to check if all dispensing operations are complete
                        function checkIfDispensingComplete() {
                          // Since we're using setTimeout for each relay, we don't need to track active operations
                          // Just check if any timers are still running by checking the document's timeouts
                          
                          // Remove the applying state from the button
                          const applyButton = document.getElementById('apply-dispenser-settings');
                          if (applyButton) {
                            applyButton.classList.remove('applying');
                          }
                          
                          // Update toast message to indicate completion
                          setTimeout(() => {
                            updateDispensingStatus('All dispensing operations complete');
                            
                            // Hide notification after 3 seconds
                            setTimeout(() => {
                              // Reset toast styles for next time
                              const dispensersToast = document.getElementById('dispensers-toast');
                              if (dispensersToast) {
                                dispensersToast.querySelector('.settings-toast-icon svg').innerHTML = 
                                  '<polyline points="20 6 9 17 4 12"></polyline>';
                                dispensersToast.querySelector('.settings-toast-content').textContent = 'Dispenser settings applied successfully';
                                dispensersToast.classList.remove('show');
                              }
                            }, 3000);
                          }, 1000);
                        }
                      });
                    </script>
                  </div>
                </div>
                
                <style>
                  /* Apply the same button styles to the schedule apply button - removing previous declaration */
                  .apply-schedule-button.applying {
                    background-color: #2a9678;
                    pointer-events: none;
                    position: relative;
                    overflow: hidden;
                  }
                  
                  .apply-schedule-button.applying::after {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    animation: shimmer 1.5s infinite;
                  }
                </style>
                
                <script>
                  // JavaScript to handle mode switching - removing this since there's only one tab now
                  document.addEventListener('DOMContentLoaded', function() {
                    // Tab switching code removed as it's no longer needed
                  });
                </script>
              </div>
            </div>

            <!-- Add the new Live Stream section after the light-section and before the dispensers-section -->
            <div id="live-stream-section" class="product-details-section">
              <div class="live-stream-container" style="width: 100%; height: 0; padding-bottom: 56.25%; position: relative; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
                <iframe 
                  id="youtube-embed"
                  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                  src="about:blank"
                  title="Waraf Live Stream"
                  frameborder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen>
                </iframe>
              </div>
              <div class="live-stream-info" style="margin-top: 20px; background-color: rgba(35, 35, 35, 0.95); padding: 25px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2); border-left: 4px solid var(--accent-color); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--accent-color), rgba(56, 181, 147, 0.3));"></div>
                
                <div style="display: flex; align-items: flex-start; gap: 20px;">
                  <div style="background-color: rgba(56, 181, 147, 0.15); min-width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M23 7l-7 5 7 5V7z"></path>
                      <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                  </div>
                  
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                      <h3 style="color: white; margin: 0; font-size: 1.4rem; font-weight: 600;">Real-time Monitoring</h3>
                      <div style="display: flex; align-items: center; margin-left: 15px; background-color: rgba(56, 181, 147, 0.2); padding: 4px 10px; border-radius: 20px;">
                        <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--accent-color); margin-right: 6px; animation: pulse 2s infinite;"></span>
                        <span style="color: var(--accent-color); font-size: 0.85rem; font-weight: 500;">LIVE</span>
                      </div>
                    </div>
                    
                    <p style="color: rgba(255, 255, 255, 0.9); line-height: 1.7; margin-bottom: 15px; font-size: 1.05rem;">
                      This live feed provides real-time visual monitoring of your hydroponics system. Watch plant growth, check system status, and monitor environmental conditions as they happen.
                    </p>
                    
                    <div style="display: flex; gap: 15px; font-size: 0.9rem;">
                      <div style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        24/7 Availability
                      </div>
                      <div style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                          <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        HD Quality
                      </div>
                      <div style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Secure Stream
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <script>
                // Initialize YouTube link from Firebase
                document.addEventListener('DOMContentLoaded', function() {
                  // Default YouTube link in case Firebase fails
                  const defaultYoutubeLink = "https://www.youtube.com/embed/ikhNOk1W6Mg?autoplay=1&mute=1&enablejsapi=1&controls=1&rel=0";
                  const youtubeEmbed = document.getElementById('youtube-embed');
                  
                  // Import Firebase modules
                  import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
                    import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
                      // Get Firebase instances
                      const db = firebaseDB.getDatabase();
                      
                      // Reference to the links node
                      const linksRef = firebaseDB.ref(db, 'links');
                      
                      // Listen for changes to the links node
                      firebaseDB.onValue(linksRef, (snapshot) => {
                        if (snapshot.exists()) {
                          const links = snapshot.val();
                          console.log('Links from Firebase for YouTube (updated):', links);
                          
                          // CORRECTED: Using youtubeStream instead of youtubeLink
                          if (links.youtubeStream) {
                            // Clean the YouTube URL if needed
                            let youtubeUrl = links.youtubeStream.trim();
                            
                            // Remove any @ symbol if present
                            if (youtubeUrl.startsWith('@')) {
                              youtubeUrl = youtubeUrl.substring(1);
                            }
                            
                            console.log('Processing YouTube URL:', youtubeUrl);
                            
                            // Check if it's a full YouTube URL or just an ID
                            if (youtubeUrl.includes('youtube.com/embed/')) {
                              // It's already an embed URL
                              console.log('Using YouTube embed URL from Firebase:', youtubeUrl);
                              youtubeEmbed.src = youtubeUrl;
                            } else if (youtubeUrl.includes('youtube.com/watch?v=')) {
                              // It's a watch URL, convert to embed
                              const videoId = new URL(youtubeUrl).searchParams.get('v');
                              const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&enablejsapi=1&controls=1&rel=0`;
                              console.log('Converted YouTube watch URL to embed URL:', embedUrl);
                              youtubeEmbed.src = embedUrl;
                            } else if (youtubeUrl.includes('youtu.be/')) {
                              // It's a shortened URL, convert to embed
                              const videoId = youtubeUrl.split('/').pop().split('?')[0];
                              const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&enablejsapi=1&controls=1&rel=0`;
                              console.log('Converted shortened YouTube URL to embed URL:', embedUrl);
                              youtubeEmbed.src = embedUrl;
                            } else {
                              // Assume it's just a video ID
                              const embedUrl = `https://www.youtube.com/embed/${youtubeUrl}?autoplay=1&mute=1&enablejsapi=1&controls=1&rel=0`;
                              console.log('Using YouTube video ID from Firebase:', embedUrl);
                              youtubeEmbed.src = embedUrl;
                            }
                          } else {
                            console.log('YouTube stream link not found in Firebase, using default');
                            youtubeEmbed.src = defaultYoutubeLink;
                          }
                        } else {
                          console.log('Links node not found in Firebase, using default YouTube link');
                          youtubeEmbed.src = defaultYoutubeLink;
                        }
                      }, (error) => {
                        console.error('Error listening to links from Firebase:', error);
                        youtubeEmbed.src = defaultYoutubeLink;
                      });
                    }).catch(error => {
                      console.error('Error importing Firebase Database:', error);
                      youtubeEmbed.src = defaultYoutubeLink;
                    });
                  }).catch(error => {
                    console.error('Error importing Firebase App:', error);
                    youtubeEmbed.src = defaultYoutubeLink;
                  });
                });
              </script>
            </div>

            <div id="dispensers-section" class="product-details-section">
              <div class="solar-power-dashboard">
                <h2 class="solar-power-title">Solar Power Monitoring</h2>
                <p class="solar-power-subtitle">Monitor your 170W solar panel's performance in real-time</p>
                
                <!-- Current Power Output -->
                <div class="solar-power-current">
                  <div class="solar-power-card">
                    <div class="solar-power-card-header">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                      </svg>
                      <h3>Current Output</h3>
                    </div>
                    <div class="solar-power-card-content">
                      <div class="solar-power-gauge">
                        <div class="solar-power-gauge-value" id="current-power-value">0</div>
                        <div class="solar-power-gauge-unit">W</div>
                      </div>
                      <div class="solar-power-gauge-label">
                        <span id="power-percentage">0</span>% of capacity
                      </div>
                    </div>
                  </div>
                  
                  <div class="solar-power-card">
                    <div class="solar-power-card-header">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                      <h3>Today's Energy</h3>
                    </div>
                    <div class="solar-power-card-content">
                      <div class="solar-power-gauge">
                        <div class="solar-power-gauge-value" id="today-energy-value">0</div>
                        <div class="solar-power-gauge-unit">Wh</div>
                      </div>
                      <div class="solar-power-gauge-label">
                        Generated today
                      </div>
                    </div>
                  </div>
                  
                  <div class="solar-power-card">
                    <div class="solar-power-card-header">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                      </svg>
                      <h3>System Status</h3>
                    </div>
                    <div class="solar-power-card-content">
                      <div class="solar-power-status">
                        <div class="solar-power-status-indicator active"></div>
                        <div class="solar-power-status-text" id="system-status">Generating Power</div>
                      </div>
                      <div class="solar-power-gauge-label" id="weather-condition">
                        Sunny conditions
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Power Output Graph -->
                <div class="solar-power-graph-container">
                  <div class="solar-power-graph-header">
                    <h3>Power Output Over Time</h3>
                    <div class="solar-power-graph-controls">
                      <button class="solar-power-graph-button active" data-timeframe="day">Day</button>
                      <button class="solar-power-graph-button" data-timeframe="week">Week</button>
                      <button class="solar-power-graph-button" data-timeframe="month">Month</button>
                    </div>
                  </div>
                  <div class="solar-power-graph-wrapper">
                    <canvas id="powerGraph"></canvas>
                  </div>
                </div>
                
                <!-- Energy Statistics -->
                <div class="solar-power-stats">
                  <div class="solar-power-stats-card">
                    <div class="solar-power-stats-header">
                      <h3>Energy Generation Statistics</h3>
                    </div>
                    <div class="solar-power-stats-grid">
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">Today</div>
                        <div class="solar-power-stats-value" id="stats-today">0 Wh</div>
                      </div>
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">Yesterday</div>
                        <div class="solar-power-stats-value" id="stats-yesterday">0 Wh</div>
                      </div>
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">This Week</div>
                        <div class="solar-power-stats-value" id="stats-week">0 kWh</div>
                      </div>
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">This Month</div>
                        <div class="solar-power-stats-value" id="stats-month">0 kWh</div>
                      </div>
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">Total</div>
                        <div class="solar-power-stats-value" id="stats-total">0 kWh</div>
                      </div>
                      <div class="solar-power-stats-item">
                        <div class="solar-power-stats-label">CO₂ Saved</div>
                        <div class="solar-power-stats-value" id="stats-co2">0 kg</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <style>
                .solar-power-dashboard {
                  padding: 20px;
                  color: #fff;
                }
                
                .solar-power-title {
                  font-size: 1.8rem;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                }
                
                .solar-power-subtitle {
                  font-size: 1rem;
                  margin-bottom: 20px;
                  opacity: 0.8;
                }
                
                .solar-power-current {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                  gap: 20px;
                  margin-bottom: 30px;
                }
                
                .solar-power-card {
                  background-color: rgba(25, 25, 25, 0.7);
                  border-radius: 10px;
                  padding: 20px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.05);
                }
                
                .solar-power-card-header {
                  display: flex;
                  align-items: center;
                  margin-bottom: 15px;
                }
                
                .solar-power-card-header svg {
                  width: 24px;
                  height: 24px;
                  stroke: var(--accent-color);
                  margin-right: 10px;
                }
                
                .solar-power-card-header h3 {
                  font-size: 1.1rem;
                  font-weight: 500;
                  margin: 0;
                }
                
                .solar-power-gauge {
                  display: flex;
                  align-items: baseline;
                  margin-bottom: 5px;
                }
                
                .solar-power-gauge-value {
                  font-size: 2.5rem;
                  font-weight: 600;
                }
                
                .solar-power-gauge-unit {
                  font-size: 1.2rem;
                  margin-left: 5px;
                  opacity: 0.8;
                }
                
                .solar-power-gauge-label {
                  font-size: 0.9rem;
                  opacity: 0.7;
                }
                
                .solar-power-status {
                  display: flex;
                  align-items: center;
                  margin-bottom: 5px;
                }
                
                .solar-power-status-indicator {
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  background-color: #777;
                  margin-right: 10px;
                }
                
                .solar-power-status-indicator.active {
                  background-color: #4caf50;
                  box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);
                }
                
                .solar-power-status-text {
                  font-size: 1.2rem;
                  font-weight: 500;
                }
                
                .solar-power-graph-container {
                  background-color: rgba(25, 25, 25, 0.7);
                  border-radius: 10px;
                  padding: 20px;
                  margin-bottom: 30px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.05);
                }
                
                .solar-power-graph-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                }
                
                .solar-power-graph-header h3 {
                  font-size: 1.1rem;
                  font-weight: 500;
                  margin: 0;
                }
                
                .solar-power-graph-controls {
                  display: flex;
                  gap: 10px;
                }
                
                .solar-power-graph-button {
                  background: rgba(255, 255, 255, 0.1);
                  border: none;
                  color: #fff;
                  padding: 5px 12px;
                  border-radius: 5px;
                  cursor: pointer;
                  transition: all 0.2s;
                }
                
                .solar-power-graph-button:hover {
                  background: rgba(var(--accent-color-rgb), 0.3);
                }
                
                .solar-power-graph-button.active {
                  background: var(--accent-color);
                }
                
                .solar-power-graph-wrapper {
                  height: 300px;
                  position: relative;
                }
                
                .solar-power-stats {
                  margin-bottom: 20px;
                }
                
                .solar-power-stats-card {
                  background-color: rgba(25, 25, 25, 0.7);
                  border-radius: 10px;
                  padding: 20px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                  border: 1px solid rgba(255, 255, 255, 0.05);
                }
                
                .solar-power-stats-header {
                  margin-bottom: 20px;
                }
                
                .solar-power-stats-header h3 {
                  font-size: 1.1rem;
                  font-weight: 500;
                  margin: 0;
                }
                
                .solar-power-stats-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 20px;
                }
                
                .solar-power-stats-item {
                  text-align: center;
                }
                
                .solar-power-stats-label {
                  font-size: 0.9rem;
                  opacity: 0.7;
                  margin-bottom: 5px;
                }
                
                .solar-power-stats-value {
                  font-size: 1.2rem;
                  font-weight: 500;
                }
                
                @media (max-width: 768px) {
                  .solar-power-current {
                    grid-template-columns: 1fr;
                  }
                  
                  .solar-power-graph-header {
                    flex-direction: column;
                    align-items: flex-start;
                  }
                  
                  .solar-power-graph-controls {
                    margin-top: 10px;
                  }
                  
                  .solar-power-stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                  }
                }
              </style>
              
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                // Solar power monitoring simulation for a 170W solar panel
                document.addEventListener('DOMContentLoaded', function() {
                  // Constants
                  const MAX_POWER = 170; // Maximum power in watts
                  
                  // Get DOM elements
                  const currentPowerValue = document.getElementById('current-power-value');
                  const powerPercentage = document.getElementById('power-percentage');
                  const todayEnergyValue = document.getElementById('today-energy-value');
                  const systemStatus = document.getElementById('system-status');
                  const weatherCondition = document.getElementById('weather-condition');
                  
                  // Stats elements
                  const statsToday = document.getElementById('stats-today');
                  const statsYesterday = document.getElementById('stats-yesterday');
                  const statsWeek = document.getElementById('stats-week');
                  const statsMonth = document.getElementById('stats-month');
                  const statsTotal = document.getElementById('stats-total');
                  const statsCO2 = document.getElementById('stats-co2');
                  
                  // Get the time of day (0-23)
                  const getCurrentHour = () => new Date().getHours();
                  
                  // Simulate solar power based on time of day
                  function generatePowerData() {
                    const hour = getCurrentHour();
                    
                    // Solar power is zero during night hours (7pm - 5am)
                    if (hour < 6 || hour > 18) {
                      return {
                        currentPower: 0,
                        percentage: 0,
                        status: 'Inactive (Night)',
                        weather: 'Night time'
                      };
                    }
                    
                    // Factor in time of day - peak around noon
                    let timeFactor;
                    if (hour <= 12) {
                      timeFactor = (hour - 6) / 6; // 0 at 6am, 1 at noon
                    } else {
                      timeFactor = 1 - ((hour - 12) / 6); // 1 at noon, 0 at 6pm
                    }
                    
                    // Add some randomness for cloud cover etc.
                    const randomFactor = 0.7 + (Math.random() * 0.3); // 0.7-1.0
                    
                    // Calculate power output
                    let power = MAX_POWER * timeFactor * randomFactor;
                    
                    // Round to whole number
                    power = Math.round(power);
                    
                    // Calculate percentage of max capacity
                    const percentage = Math.round((power / MAX_POWER) * 100);
                    
                    // Determine weather condition based on random factor
                    let weather;
                    let status;
                    
                    if (randomFactor > 0.9) {
                      weather = 'Sunny conditions';
                      status = 'Optimal Generation';
                    } else if (randomFactor > 0.8) {
                      weather = 'Partly cloudy';
                      status = 'Good Generation';
                    } else {
                      weather = 'Cloudy conditions';
                      status = 'Reduced Generation';
                    }
                    
                    // If power is very low during the day, might be heavily overcast
                    if (power < MAX_POWER * 0.2 && hour >= 8 && hour <= 16) {
                      weather = 'Heavy cloud cover';
                      status = 'Minimal Generation';
                    }
                    
                    return {
                      currentPower: power,
                      percentage,
                      status,
                      weather
                    };
                  }
                  
                  // Energy calculation (Wh) based on average power over time
                  function calculateEnergy() {
                    const hour = getCurrentHour();
                    let totalEnergyToday = 0;
                    
                    // Calculate energy generated so far today
                    for (let h = 6; h <= Math.min(hour, 18); h++) {
                      // Simulate the curve of power generation throughout the day
                      let timeFactor;
                      if (h <= 12) {
                        timeFactor = (h - 6) / 6; // 0 at 6am, 1 at noon
                      } else {
                        timeFactor = 1 - ((h - 12) / 6); // 1 at noon, 0 at 6pm
                      }
                      
                      // Average power for this hour (watts)
                      const avgPower = MAX_POWER * timeFactor * (0.7 + (Math.random() * 0.3));
                      
                      // Energy in watt-hours (power × time)
                      totalEnergyToday += avgPower;
                    }
                    
                    // Round to whole number
                    totalEnergyToday = Math.round(totalEnergyToday);
                    
                    return {
                      today: totalEnergyToday,
                      yesterday: Math.round(700 + Math.random() * 200),
                      week: (4.5 + Math.random()).toFixed(1),
                      month: (18 + Math.random() * 5).toFixed(1),
                      total: (120 + Math.random() * 30).toFixed(1),
                      co2: (60 + Math.random() * 15).toFixed(1)
                    };
                  }
                  
                  // Generate hourly data for the graph
                  function generateHourlyData() {
                    const data = [];
                    const labels = [];
                    const hour = getCurrentHour();
                    
                    // Generate data for each hour of the day
                    for (let h = 0; h < 24; h++) {
                      labels.push(`${h}:00`);
                      
                      // If this hour hasn't occurred yet today, show no data
                      if (h > hour) {
                        data.push(null);
                        continue;
                      }
                      
                      // No power at night
                      if (h < 6 || h > 18) {
                        data.push(0);
                        continue;
                      }
                      
                      // Calculate power for this hour
                      let timeFactor;
                      if (h <= 12) {
                        timeFactor = (h - 6) / 6; // 0 at 6am, 1 at noon
                      } else {
                        timeFactor = 1 - ((h - 12) / 6); // 1 at noon, 0 at 6pm
                      }
                      
                      const randomFactor = 0.7 + (Math.random() * 0.3);
                      const power = Math.round(MAX_POWER * timeFactor * randomFactor);
                      
                      data.push(power);
                    }
                    
                    return { data, labels };
                  }
                  
                  // Initialize graph
                  function initGraph() {
                    const ctx = document.getElementById('powerGraph').getContext('2d');
                    const { data, labels } = generateHourlyData();
                    
                    const chart = new Chart(ctx, {
                      type: 'line',
                      data: {
                        labels: labels,
                        datasets: [{
                          label: 'Power (W)',
                          data: data,
                          borderColor: 'rgb(39, 174, 96)',
                          backgroundColor: 'rgba(39, 174, 96, 0.1)',
                          borderWidth: 2,
                          fill: true,
                          tension: 0.4,
                          pointRadius: 3,
                          pointBackgroundColor: 'rgb(39, 174, 96)'
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                          legend: {
                            display: false
                          },
                          tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                              size: 14
                            },
                            bodyFont: {
                              size: 14
                            }
                          }
                        },
                        scales: {
                          x: {
                            grid: {
                              color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                              color: 'rgba(255, 255, 255, 0.7)'
                            }
                          },
                          y: {
                            beginAtZero: true,
                            max: MAX_POWER * 1.1,
                            grid: {
                              color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                              color: 'rgba(255, 255, 255, 0.7)'
                            }
                          }
                        }
                      }
                    });
                    
                    return chart;
                  }
                  
                  // Set up graph timeframe buttons
                  function setupGraphControls(chart) {
                    const buttons = document.querySelectorAll('.solar-power-graph-button');
                    
                    buttons.forEach(button => {
                      button.addEventListener('click', () => {
                        // Remove active class from all buttons
                        buttons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        button.classList.add('active');
                        
                        // Get timeframe
                        const timeframe = button.getAttribute('data-timeframe');
                        
                        // Update graph based on timeframe
                        if (timeframe === 'day') {
                          const { data, labels } = generateHourlyData();
                          chart.data.labels = labels;
                          chart.data.datasets[0].data = data;
                          chart.options.scales.x.title = {
                            display: true,
                            text: 'Hour of Day'
                          };
                        } else if (timeframe === 'week') {
                          // Generate weekly data
                          const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                          const weekData = days.map(() => Math.round(500 + Math.random() * 300));
                          
                          chart.data.labels = days;
                          chart.data.datasets[0].data = weekData;
                          chart.options.scales.x.title = {
                            display: true,
                            text: 'Day of Week'
                          };
                        } else if (timeframe === 'month') {
                          // Generate monthly data
                          const days = Array.from({length: 30}, (_, i) => (i + 1).toString());
                          const monthData = days.map(() => Math.round(500 + Math.random() * 300));
                          
                          chart.data.labels = days;
                          chart.data.datasets[0].data = monthData;
                          chart.options.scales.x.title = {
                            display: true,
                            text: 'Day of Month'
                          };
                        }
                        
                        chart.update();
                      });
                    });
                  }
                  
                  // Update display
                  function updateDisplay() {
                    // Generate power data
                    const powerData = generatePowerData();
                    
                    // Update current power display
                    currentPowerValue.textContent = powerData.currentPower;
                    powerPercentage.textContent = powerData.percentage;
                    
                    // Update system status
                    systemStatus.textContent = powerData.status;
                    weatherCondition.textContent = powerData.weather;
                    
                    // Update system status indicator
                    const statusIndicator = document.querySelector('.solar-power-status-indicator');
                    if (powerData.currentPower > 0) {
                      statusIndicator.classList.add('active');
                    } else {
                      statusIndicator.classList.remove('active');
                    }
                    
                    // Calculate energy data
                    const energyData = calculateEnergy();
                    
                    // Update energy displays
                    todayEnergyValue.textContent = energyData.today;
                    
                    // Update stats
                    statsToday.textContent = `${energyData.today} Wh`;
                    statsYesterday.textContent = `${energyData.yesterday} Wh`;
                    statsWeek.textContent = `${energyData.week} kWh`;
                    statsMonth.textContent = `${energyData.month} kWh`;
                    statsTotal.textContent = `${energyData.total} kWh`;
                    statsCO2.textContent = `${energyData.co2} kg`;
                  }
                  
                  // Initialize
                  const chart = initGraph();
                  setupGraphControls(chart);
                  updateDisplay();
                  
                  // Update data periodically
                  setInterval(updateDisplay, 60000); // Update every minute
                });
              </script>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
      <div class="footer__container">
        <a href="#" class="footer__policy">Privacy Policy – Terms & Conditions</a>
        <a href="" class="footer__logo logo">Waraf</a>
        <div class="footer__copyright">Copyright © 2025 Waraf – All Rights Reserved</div>
      </div>
    </footer>
  </div>

  <!-- Auth Modal -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-container">
      <div class="auth-close" id="auth-close">&times;</div>
      <h2 class="auth-title">Welcome to Waraf</h2>
      
      <div class="auth-tabs">
        <div class="auth-tab active" id="login-tab">Login</div>
        <div class="auth-tab" id="register-tab">Register</div>
      </div>
      
      <form class="auth-form active" id="login-form">
        <div class="auth-input-group">
          <label class="auth-label" for="login-email">Email</label>
          <input type="email" id="login-email" class="auth-input" required>
        </div>
        <div class="auth-input-group">
          <label class="auth-label" for="login-password">Password</label>
          <input type="password" id="login-password" class="auth-input" required>
        </div>
        <button type="submit" class="auth-button">Login</button>
        <div class="auth-message"></div>
        
        <div class="auth-divider">
          <div class="auth-divider-line"></div>
          <div class="auth-divider-text">or</div>
          <div class="auth-divider-line"></div>
        </div>
        
        <button type="button" class="auth-social-button google-login-button">
          <svg class="auth-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
          </svg>
          Continue with Google
        </button>
      </form>
      
      <form class="auth-form" id="register-form">
        <div class="auth-input-group">
          <label class="auth-label" for="register-email">Email</label>
          <input type="email" id="register-email" class="auth-input" required>
        </div>
        <div class="auth-input-group">
          <label class="auth-label" for="register-password">Password</label>
          <input type="password" id="register-password" class="auth-input" required>
        </div>
        <div class="auth-input-group">
          <label class="auth-label" for="register-confirm-password">Confirm Password</label>
          <input type="password" id="register-confirm-password" class="auth-input" required>
        </div>
        <button type="submit" class="auth-button">Create Account</button>
        <div class="auth-message"></div>
        
        <div class="auth-divider">
          <div class="auth-divider-line"></div>
          <div class="auth-divider-text">or</div>
          <div class="auth-divider-line"></div>
        </div>
        
        <button type="button" class="auth-social-button google-login-button">
          <svg class="auth-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
          </svg>
          Continue with Google
        </button>
      </form>
    </div>
  </div>

  <script type="module" src="js/script.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      get, 
      set,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDDb9YOroocw_2O-NO34EFw8ojcu3sUcS4",
      authDomain: "waraf-1c450.firebaseapp.com",
      databaseURL: "https://waraf-1c450-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "waraf-1c450",
      storageBucket: "waraf-1c450.firebasestorage.app",
      messagingSenderId: "464312561630",
      appId: "1:464312561630:web:1e42b976469cc43c65f74f",
      measurementId: "G-FS9EMEYZZT"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    
    // Firebase Auth Credentials
    const USER_EMAIL = "oja13149@bcooq.com";
    const USER_PASSWORD = "123456";
    
    // Flag to track if authentication is in progress
    let authInProgress = false;
    
    // Flag to track if data subscription is active
    let dataSubscriptionActive = false;
    
    // Status display element
    let statusMessageElement = null;
    
    // Get product ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    // Navigation between sections
    function initNavigation() {
      const navItems = document.querySelectorAll('.product-details-nav-item');
      const sections = document.querySelectorAll('.product-details-section');
      
      // Handle tab switching
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          // Remove active class from all tabs and sections
          navItems.forEach(tab => tab.classList.remove('active'));
          sections.forEach(section => section.classList.remove('active'));
          
          // Add active class to clicked tab
          item.classList.add('active');
          
          // Get and activate the corresponding section
          const sectionId = item.getAttribute('data-section');
          document.getElementById(`${sectionId}-section`).classList.add('active');
        });
      });
      
      // Back to dashboard button
      const backButton = document.getElementById('back-to-dashboard');
      if (backButton) {
        backButton.addEventListener('click', () => {
          window.location.href = 'dashboard.html';
        });
      }
    }
    
    // Function to create status display
    function createStatusDisplay() {
      // Create container for status
      const container = document.createElement('div');
      container.className = 'sensors-status-container';
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.justifyContent = 'space-between';
      container.style.marginTop = '15px';
      container.style.padding = '10px';
      container.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
      container.style.borderRadius = '5px';
      
      // Create status message element
      statusMessageElement = document.createElement('div');
      statusMessageElement.className = 'sensors-status-message';
      statusMessageElement.textContent = 'Initializing data connection...';
      statusMessageElement.style.fontSize = '0.9rem';
      statusMessageElement.style.color = 'rgba(255, 255, 255, 0.7)';
      statusMessageElement.style.width = '100%';
      statusMessageElement.style.textAlign = 'center';
      
      // Add elements to container
      container.appendChild(statusMessageElement);
      
      // Add container to the sensors dashboard
      const sensorsDashboard = document.querySelector('.sensors-dashboard');
      if (sensorsDashboard) {
        sensorsDashboard.appendChild(container);
      }
    }
    
    // Function to update the status message
    function updateStatusMessage(message, type = 'info') {
      if (!statusMessageElement) return;
      
      statusMessageElement.textContent = message;
      
      // Reset styles
      statusMessageElement.style.color = 'rgba(255, 255, 255, 0.7)';
      
      // Apply styles based on message type
      if (type === 'error') {
        statusMessageElement.style.color = '#FF6B6B'; // Red for errors
      } else if (type === 'success') {
        statusMessageElement.style.color = 'var(--accent-color)'; // Website's accent color for success
      } else if (type === 'warning') {
        statusMessageElement.style.color = '#FFD166'; // Yellow for warnings
      }
    }
    
    // Function to authenticate with Firebase
    async function authenticateFirebase() {
      if (authInProgress) return false;
      
      authInProgress = true;
      updateStatusMessage('Authenticating with Firebase...', 'info');
      
      try {
        // Sign in with the provided credentials
        const userCredential = await signInWithEmailAndPassword(auth, USER_EMAIL, USER_PASSWORD);
        console.log('Firebase authentication successful', userCredential.user.uid);
        updateStatusMessage('Authentication successful', 'success');
        authInProgress = false;
        return true;
      } catch (error) {
        console.error('Firebase authentication error:', error.code, error.message);
        updateStatusMessage(`Authentication error: ${error.message}`, 'error');
        authInProgress = false;
        return false;
      }
    }
    
    // Temperature chart instance
    let temperatureChart = null;
    
    // Function to fetch temperature history data
    async function fetchTemperatureHistory() {
      try {
        // Reference to temperature readings
        const readingsRef = ref(database, 'TemperatureSensor/readings');
        
        // Get the data
        const snapshot = await get(readingsRef);
        if (snapshot.exists()) {
          const readings = snapshot.val();
          
          // Process the data for the chart
          const chartData = processTemperatureReadings(readings);
          
          // Render the chart
          renderTemperatureChart(chartData);
          
          // Update min/max values in stats
          updateTemperatureStats(chartData.temperatures);
          
          return true;
        } else {
          console.log('No temperature history data available');
          updateStatusMessage('No temperature history available', 'warning');
          return false;
        }
      } catch (error) {
        console.error('Error fetching temperature history:', error);
        updateStatusMessage('Error loading temperature history', 'error');
        return false;
      }
    }
    
    // Function to process temperature readings for the chart
    function processTemperatureReadings(readings) {
      // Convert object to sorted array
      const readingsArray = Object.entries(readings)
        .map(([timestamp, data]) => ({
          timestamp: parseInt(timestamp),
          formattedTime: data.formatted_time,
          temperature: data.temperature
        }))
        .sort((a, b) => a.timestamp - b.timestamp); // Sort by timestamp (oldest first)
      
      // Extract labels (time) and data (temperature) for the chart
      const labels = readingsArray.map(reading => {
        // Extract only the time part (HH:MM:SS) from the formatted time
        const formattedTime = reading.formattedTime;
        if (formattedTime.includes(' ')) {
          // If format is "YYYY-MM-DD HH:MM:SS"
          return formattedTime.split(' ')[1].substring(0, 5); // Get only HH:MM
        } else {
          // If format is already just the time
          return formattedTime.substring(0, 5); // Get only HH:MM
        }
      });
      
      const temperatures = readingsArray.map(reading => reading.temperature);
      
      return {
        labels,
        temperatures
      };
    }
    
    // Function to update temperature stats (min/max)
    function updateTemperatureStats(temperatures) {
      if (!temperatures || temperatures.length === 0) return;
      
      // Calculate min and max
      const min = Math.min(...temperatures);
      const max = Math.max(...temperatures);
      
      // Update the UI
      const minElement = document.querySelector('.sensor-stat-card:first-child .sensor-stat-value:first-child .stat-value');
      const maxElement = document.querySelector('.sensor-stat-card:first-child .sensor-stat-value:last-child .stat-value');
      
      if (minElement) minElement.textContent = min.toFixed(1) + '°C';
      if (maxElement) maxElement.textContent = max.toFixed(1) + '°C';
    }
    
    // Function to render the temperature chart
    function renderTemperatureChart(chartData) {
      // Get the canvas element
      const ctx = document.getElementById('temperature-chart-canvas').getContext('2d');
      
      // If chart already exists, destroy it to prevent memory leaks
      if (temperatureChart) {
        temperatureChart.destroy();
      }
      
      // Set y-axis min and max values as specified: 16°C to 32°C
      const yMin = 16;
      const yMax = 32;
      
      // Create new chart
      temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Temperature (°C)',
            data: chartData.temperatures,
            borderColor: 'rgb(56, 181, 147)',
            backgroundColor: 'rgba(56, 181, 147, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 2,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleColor: 'rgb(56, 181, 147)',
              bodyColor: 'white',
              borderColor: 'rgb(56, 181, 147)',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                title: function(tooltipItems) {
                  return chartData.labels[tooltipItems[0].dataIndex];
                },
                label: function(context) {
                  return context.formattedValue + '°C';
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 8
              }
            },
            y: {
              min: yMin,
              max: yMax,
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                stepSize: 4,
                callback: function(value) {
                  return value + '°C';
                }
              }
            }
          }
        }
      });
    }
    
    // Function to set up real-time temperature monitoring
    function setupRealTimeTemperatureMonitoring() {
      if (dataSubscriptionActive) return;
      
      updateStatusMessage('Setting up real-time temperature monitoring...', 'info');
      
      try {
        // Reference to the latest temperature value
        const tempRef = ref(database, 'TemperatureSensor/latest');
        
        // Set up real-time listener
        onValue(tempRef, (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            const tempValue = data.temperature;
            const timestamp = data.formatted_time;
            
            // Update the temperature display
            const tempDisplay = document.querySelector('.sensor-value-card:first-child .sensor-value-reading');
            if (tempDisplay) {
              tempDisplay.innerHTML = tempValue.toFixed(1) + '<span class="sensor-value-unit">°C</span>';
            }
            
            console.log('Temperature updated in real-time:', tempValue, 'at', timestamp);
            updateStatusMessage('Data connection active', 'success');
          } else {
            console.log('No temperature data available');
            updateStatusMessage('Waiting for data...', 'warning');
          }
        }, (error) => {
          console.error('Error in real-time temperature monitoring:', error);
          updateStatusMessage(`Connection error. Will retry automatically.`, 'error');
          
          // Re-establish connection after a delay
          setTimeout(() => {
            if (auth.currentUser) {
              setupRealTimeTemperatureMonitoring();
            }
          }, 10000); // Retry after 10 seconds
        });
        
        dataSubscriptionActive = true;
        updateStatusMessage('Data connection active', 'success');
        
      } catch (error) {
        console.error('Error setting up real-time monitoring:', error);
        updateStatusMessage(`Connection error. Will retry automatically.`, 'error');
        dataSubscriptionActive = false;
        
        // Retry setup after delay
        setTimeout(() => {
          if (auth.currentUser) {
            setupRealTimeTemperatureMonitoring();
          }
        }, 10000); // Retry after 10 seconds
      }
    }
    
    // Function to initialize data connection
    async function initializeDataConnection() {
      try {
        // Try to authenticate with Firebase
        const isAuthenticated = auth.currentUser || await authenticateFirebase();
        
        if (isAuthenticated) {
          // Set up real-time temperature monitoring
          setupRealTimeTemperatureMonitoring();
          
          // Fetch temperature history for the chart
          await fetchTemperatureHistory();
          
          return true;
        } else {
          updateStatusMessage('Authentication failed. Cannot establish real-time connection.', 'error');
          
          // Retry authentication after delay
          setTimeout(initializeDataConnection, 30000); // Retry after 30 seconds
          return false;
        }
      } catch (error) {
        console.error('Error initializing data connection:', error);
        updateStatusMessage(`Connection error: ${error.message}. Will retry automatically.`, 'error');
        
        // Retry after delay
        setTimeout(initializeDataConnection, 30000); // Retry after 30 seconds
        return false;
      }
    }
    
    // Initialize immediately and again on DOMContentLoaded to ensure elements are captured
    initNavigation();
    
    document.addEventListener('DOMContentLoaded', async () => {
      // Re-initialize navigation on DOM content loaded (as a fallback)
      initNavigation();
      
      // Create status display
      createStatusDisplay();
      
      // Initialize data connection
      await initializeDataConnection();
      
      // Add visibility change listener to handle page coming back into focus
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          // Page is now visible again, check if we need to reconnect
          if (!dataSubscriptionActive && auth.currentUser) {
            updateStatusMessage('Page is visible again, reconnecting...', 'info');
            setupRealTimeTemperatureMonitoring();
          }
        }
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const manualButton = document.getElementById('dispensers-manual-button');
      const automaticButton = document.getElementById('dispensers-automatic-button');
      const manualContent = document.getElementById('dispensers-manual-content');
      const automaticContent = document.getElementById('dispensers-automatic-content');
      
      manualButton.addEventListener('click', function() {
        manualButton.classList.add('active');
        automaticButton.classList.remove('active');
        manualContent.classList.add('active');
        automaticContent.classList.remove('active');
      });
      
      automaticButton.addEventListener('click', function() {
        automaticButton.classList.add('active');
        manualButton.classList.remove('active');
        automaticContent.classList.add('active');
        manualContent.classList.remove('active');
      });
    });
  </script>

  <!-- Sensors Management JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const addSensorsButtonEmpty = document.getElementById('add-sensors-button-empty');
      const addSensorsButton = document.getElementById('add-sensors-button');
      const sensorsModal = document.getElementById('sensors-modal');
      const modalClose = document.querySelector('.sensors-modal-close');
      const modalCancel = document.getElementById('modal-cancel');
      const modalAddSelected = document.getElementById('modal-add-selected');
      const sensorsList = document.getElementById('sensors-list');
      const sensorsGrid = document.getElementById('sensors-grid');
      const sensorsEmptyState = document.getElementById('sensors-empty-state');
      const sensorsGridContainer = document.getElementById('sensors-grid-container');
      
      // Firebase references
      let database;
      let auth;
      let userUID = null;
      
      // Import Firebase modules
      import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
        import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js').then((firebaseAuth) => {
            // Get Firebase instances from the global scope (they're already initialized in the script at the bottom of the page)
            database = firebaseDB.getDatabase();
            auth = firebaseAuth.getAuth();
            
            // Check if user is authenticated
            if (auth.currentUser) {
              userUID = auth.currentUser.uid;
              loadSensorsFromFirebase();
            } else {
              // If not authenticated yet, wait a bit and try using the fixed auth credentials
              setTimeout(() => {
                firebaseAuth.signInWithEmailAndPassword(auth, "oja13149@bcooq.com", "123456")
                  .then((userCredential) => {
                    userUID = userCredential.user.uid;
                    loadSensorsFromFirebase();
                  })
                  .catch((error) => {
                    console.error("Authentication error:", error);
                    // Fall back to local storage if Firebase auth fails
                    loadSensorsFromLocalStorage();
                  });
              }, 1000);
            }
            
            // Listen for auth state changes
            firebaseAuth.onAuthStateChanged(auth, (user) => {
              if (user) {
                userUID = user.uid;
                loadSensorsFromFirebase();
              }
            });
          }).catch(error => {
            console.error("Error importing Firebase Auth:", error);
            // Fall back to local storage
            loadSensorsFromLocalStorage();
          });
        }).catch(error => {
          console.error("Error importing Firebase Database:", error);
          // Fall back to local storage
          loadSensorsFromLocalStorage();
        });
      }).catch(error => {
        console.error("Error importing Firebase App:", error);
        // Fall back to local storage
        loadSensorsFromLocalStorage();
      });
      
      // Sensor definitions with their details
      const sensorTypes = [
        {
          id: 'ph',
          name: 'Potential of Hydrogen (pH)',
          description: 'Measures acidity or alkalinity of the nutrient solution',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"></circle><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="normal" fill="none" stroke="currentColor" stroke-width="1">H</text></svg>',
          unit: 'pH',
          minValue: 0,
          maxValue: 14,
          optimalMin: 5.5,
          optimalMax: 6.5,
          defaultValue: 6.0
        },
        {
          id: 'ec',
          name: 'Electrical Conductivity (EC)',
          description: 'Indicates the concentration of dissolved nutrients',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>',
          unit: 'μS/cm',
          minValue: 0,
          maxValue: 5000,
          optimalMin: 1200,
          optimalMax: 2500,
          defaultValue: 1800
        },
        {
          id: 'tds',
          name: 'Total Dissolved Solids (TDS)',
          description: 'Measures the total concentration of dissolved substances',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><circle cx="12" cy="16" r="2"></circle></svg>',
          unit: 'ppm',
          minValue: 0,
          maxValue: 2000,
          optimalMin: 600,
          optimalMax: 1200,
          defaultValue: 900
        },
        {
          id: 'water_temp',
          name: 'Nutrient Solution Temperature',
          description: 'Tracks the temperature of the nutrient solution',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><line x1="12" y1="9" x2="12" y2="15"></line><circle cx="12" cy="17" r="2"></circle></svg>',
          unit: '°C',
          minValue: 10,
          maxValue: 35,
          optimalMin: 18,
          optimalMax: 23,
          defaultValue: 21
        },
        {
          id: 'air_temp',
          name: 'Air Temperature',
          description: 'Monitors ambient temperature around plants',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"></path><path d="M12 21v2"></path><path d="M4.22 4.22l1.42 1.42"></path><path d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"></path><path d="M21 12h2"></path><path d="M4.22 19.78l1.42-1.42"></path><path d="M18.36 5.64l1.42-1.42"></path></svg>',
          unit: '°C',
          minValue: 15,
          maxValue: 40,
          optimalMin: 21,
          optimalMax: 29,
          defaultValue: 24
        },
        {
          id: 'co2',
          name: 'Carbon Dioxide (CO₂)',
          description: 'Measures CO₂ concentration for optimal plant growth',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12a2 2 0 1 0 4 0 2 2 0 1 0 -4 0"></path><path d="M14 10a2 2 0 1 0 4 0 2 2 0 1 0 -4 0"></path><path d="M14 14a2 2 0 1 0 4 0 2 2 0 1 0 -4 0"></path></svg>',
          unit: 'ppm',
          minValue: 0,
          maxValue: 2000,
          optimalMin: 800,
          optimalMax: 1200,
          defaultValue: 950
        },
        {
          id: 'humidity',
          name: 'Humidity',
          description: 'Tracks relative humidity in growing environment',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><path d="M8 13a4 4 0 0 1 8 0"></path></svg>',
          unit: '%',
          minValue: 0,
          maxValue: 100,
          optimalMin: 40,
          optimalMax: 70,
          defaultValue: 60
        },
        {
          id: 'light',
          name: 'Light Intensity',
          description: 'Measures light levels for photosynthesis',
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M5 5l1.5 1.5"></path><path d="M17.5 17.5l1.5 1.5"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M5 19l1.5-1.5"></path><path d="M17.5 6.5l1.5-1.5"></path></svg>',
          unit: 'lux',
          minValue: 0,
          maxValue: 100000,
          optimalMin: 15000,
          optimalMax: 50000,
          defaultValue: 35000
        }
      ];
      
      // Array to track added sensors
      let addedSensors = [];
      // Reference to the sensor data in Firebase
      let sensorDataRef = null;
      // Object to store the latest sensor values from Firebase
      let sensorValues = {};
      
      // Initial setup
      function init() {
        renderSensorOptions();
        setupEventListeners();
        // Note: We don't call updateUI() here anymore since we'll load sensors first
      }
      
      // Function to set up real-time listener for sensor data
      function setupSensorDataListener() {
        if (!database) {
          console.error("Firebase database not initialized");
          return;
        }
        
        try {
          // Set up real-time listener for sensor data changes
          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
            // Create a reference to the sensordata node using the imported firebaseDB
            sensorDataRef = firebaseDB.ref(database, "sensordata");
            
            // Listen for changes
            firebaseDB.onValue(sensorDataRef, (snapshot) => {
              if (snapshot.exists()) {
                const data = snapshot.val();
                console.log("Received sensor data from Firebase:", data);
                
                // Store the sensor values
                sensorValues = data;
                
                // Update the UI if sensors are already loaded
                if (addedSensors.length > 0) {
                  renderSensorCards();
                }
                
                // Check for critical values and take action if needed
                checkCriticalSensorValues(data, firebaseDB);
              } else {
                console.log("No sensor data available in Firebase");
              }
            }, (error) => {
              console.error("Error setting up sensor data listener:", error);
            });
          }).catch(error => {
            console.error("Error importing Firebase Database for sensor data:", error);
          });
        } catch (error) {
          console.error("Error in setupSensorDataListener:", error);
        }
      }
      
      // Function to check for critical sensor values and take safety actions
      function checkCriticalSensorValues(data, firebaseDB) {
        let isEmergency = false;
        let emergencyMessage = "";
        
        // Check pH value - if above 7.5, trigger emergency shutdown
        if (data.pH && data.pH.value !== null && data.pH.value !== undefined) {
          const pHValue = parseFloat(data.pH.value);
          if (!isNaN(pHValue) && pHValue > 7.5) {
            isEmergency = true;
            emergencyMessage = `Emergency shutdown: pH level too high (${pHValue.toFixed(1)})`;
            console.warn(`Critical pH value detected: ${pHValue.toFixed(1)} - exceeds maximum threshold (7.5)`);
          }
        }
        
        // Check water temperature - if above 40°C, trigger emergency shutdown
        if (data.waterTemp && data.waterTemp.value !== null && data.waterTemp.value !== undefined) {
          const tempValue = parseFloat(data.waterTemp.value);
          if (!isNaN(tempValue) && tempValue > 40) {
            isEmergency = true;
            emergencyMessage = `Emergency shutdown: Nutrient solution temperature too high (${tempValue.toFixed(1)}°C)`;
            console.warn(`Critical water temperature detected: ${tempValue.toFixed(1)}°C - exceeds maximum threshold (40°C)`);
          }
        }
        
        // If any emergency condition is met, shut down all relays
        if (isEmergency) {
          emergencyShutdown(firebaseDB, emergencyMessage);
        }
      }
      
      // Function to shut down all relays in case of emergency
      function emergencyShutdown(firebaseDB, message) {
        // Get database instance
        const db = firebaseDB.getDatabase();
        
        // Create a structure with all relays set to false
        const relayUpdates = {
          relay1: false,
          relay2: false,
          relay3: false,
          relay4: false,
          relay5: false,
          relay6: false,
          relay7: false,
          relay8: false,
          relay9: false,
          relay10: false,
          relay11: false,
          relay12: false
        };
        
        // Reference to the relays node
        const relaysRef = firebaseDB.ref(db, 'relays');
        
        // Update Firebase with all relays turned off
        firebaseDB.update(relaysRef, relayUpdates)
          .then(() => {
            console.log('EMERGENCY SHUTDOWN ACTIVATED: All relays turned off due to critical sensor values');
            // Show emergency notification
            showEmergencyNotification(message);
          })
          .catch((error) => {
            console.error('Failed to execute emergency shutdown:', error);
          });
      }
      
      // Function to show emergency notification
      function showEmergencyNotification(message) {
        // Create notification if it doesn't exist yet
        let emergencyToast = document.getElementById('emergency-toast');
        if (!emergencyToast) {
          emergencyToast = document.createElement('div');
          emergencyToast.id = 'emergency-toast';
          emergencyToast.className = 'emergency-toast';
          
          const toastIcon = document.createElement('div');
          toastIcon.className = 'emergency-toast-icon';
          toastIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          `;
          
          const toastContent = document.createElement('div');
          toastContent.className = 'emergency-toast-content';
          toastContent.textContent = message;
          
          emergencyToast.appendChild(toastIcon);
          emergencyToast.appendChild(toastContent);
          document.body.appendChild(emergencyToast);
        } else {
          // Update existing toast with new message
          emergencyToast.querySelector('.emergency-toast-content').textContent = message;
        }
        
        // Add show class to make it visible
        emergencyToast.classList.add('show');
        
        // Keep the notification visible until user acknowledges it
        const dismissButton = document.createElement('button');
        dismissButton.className = 'emergency-toast-dismiss';
        dismissButton.innerHTML = 'Acknowledge';
        dismissButton.onclick = function() {
          emergencyToast.classList.remove('show');
          setTimeout(() => {
            emergencyToast.classList.add('acknowledged');
          }, 500);
        };
        
        // Add dismiss button if it doesn't exist yet
        if (!emergencyToast.querySelector('.emergency-toast-dismiss')) {
          emergencyToast.appendChild(dismissButton);
        }
      }
      
      // Add emergency toast styles
      (function addEmergencyStyles() {
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          .emergency-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10000;
            max-width: 90%;
            width: 500px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid #b90000;
          }
          
          .emergency-toast.show {
            opacity: 1;
            visibility: visible;
            animation: emergencyPulse 2s infinite;
          }
          
          .emergency-toast.acknowledged {
            animation: none;
          }
          
          .emergency-toast-icon {
            display: flex;
            flex-shrink: 0;
          }
          
          .emergency-toast-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
          }
          
          .emergency-toast-content {
            flex: 1;
            font-weight: 500;
            font-size: 1.1rem;
          }
          
          .emergency-toast-dismiss {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
          }
          
          .emergency-toast-dismiss:hover {
            background-color: rgba(255, 255, 255, 0.3);
          }
          
          @keyframes emergencyPulse {
            0%, 100% {
              box-shadow: 0 5px 20px rgba(220, 53, 69, 0.3);
            }
            50% {
              box-shadow: 0 5px 25px rgba(220, 53, 69, 0.8);
            }
          }
        `;
        document.head.appendChild(styleElement);
      })();
      
      // Get sensor value from Firebase data or fallback to default
      function getSensorValue(sensorId) {
        // Map sensor IDs to the corresponding Firebase data property
        const sensorMap = {
          'ph': 'pH',
          'ec': 'EC',
          'tds': 'tds',
          'water_temp': 'waterTemp',
          'air_temp': 'airTemp',
          'co2': 'airCO2',
          'humidity': 'humidity',
          'light': 'lux'
        };
        
        // Get the appropriate key for this sensor
        const firebaseKey = sensorMap[sensorId];
        
        if (!firebaseKey || !sensorValues || !sensorValues[firebaseKey]) {
          // Special case for EC - it's calculated from TDS and doesn't have a direct value in Firebase
          if (sensorId === 'ec') {
            // Get TDS value and calculate EC if TDS exists
            if (sensorValues && sensorValues.tds && sensorValues.tds.value !== null && sensorValues.tds.value !== undefined) {
              const tdsValue = parseFloat(sensorValues.tds.value);
              if (!isNaN(tdsValue)) {
                // Get ECfactor, default to 2 if not available
                const ecFactor = (sensorValues.factors && sensorValues.factors.ECfactor) ? 
                  parseFloat(sensorValues.factors.ECfactor) : 2;
                
                // Calculate EC value as TDS × ECfactor
                const ecValue = tdsValue * ecFactor;
                console.log(`Calculated EC value from TDS: ${tdsValue} × ${ecFactor} = ${ecValue} μS/cm`);
                return ecValue;
              }
            }
            return null;
          }
          return null;
        }
        
        // Get the value from Firebase
        let value = sensorValues[firebaseKey].value;
        
        // Apply TDSfactor for TDS sensor if factors exist in Firebase data
        if (sensorId === 'tds' && sensorValues.factors && sensorValues.factors.TDSfactor) {
          // Apply the multiplication factor to the TDS value
          value = value * sensorValues.factors.TDSfactor;
          console.log(`Applied TDSfactor ${sensorValues.factors.TDSfactor} to TDS value: ${sensorValues.tds.value} → ${value}`);
        }
        
        return value;
      }
      
      // Get min value from Firebase data
      function getSensorMin(sensorId) {
        // Map sensor IDs to the corresponding Firebase data property
        const sensorMap = {
          'ph': 'pH',
          'ec': 'EC', 
          'tds': 'tds',
          'water_temp': 'waterTemp',
          'air_temp': 'airTemp',
          'co2': 'airCO2',
          'humidity': 'humidity',
          'light': 'lux'
        };
        
        // Get the appropriate key for this sensor
        const firebaseKey = sensorMap[sensorId];
        
        // Special case for EC - it doesn't have direct values in Firebase
        if (sensorId === 'ec') {
          return null; // Use default min value from sensorTypes
        }
        
        if (!firebaseKey || !sensorValues || !sensorValues[firebaseKey]) {
          return null;
        }
        
        // Get the min value from Firebase
        return sensorValues[firebaseKey].min;
      }
      
      // Get max value from Firebase data
      function getSensorMax(sensorId) {
        // Map sensor IDs to the corresponding Firebase data property
        const sensorMap = {
          'ph': 'pH',
          'ec': 'EC',
          'tds': 'tds',
          'water_temp': 'waterTemp',
          'air_temp': 'airTemp',
          'co2': 'airCO2',
          'humidity': 'humidity',
          'light': 'lux'
        };
        
        // Get the appropriate key for this sensor
        const firebaseKey = sensorMap[sensorId];
        
        // Special case for EC - it doesn't have direct values in Firebase
        if (sensorId === 'ec') {
          return null; // Use default max value from sensorTypes
        }
        
        if (!firebaseKey || !sensorValues || !sensorValues[firebaseKey]) {
          return null;
        }
        
        // Get the max value from Firebase
        return sensorValues[firebaseKey].max;
      }
      
      // Format sensor value for display
      function formatSensorValue(value, sensorId, sensor) {
        // If value is empty string or null/undefined, return "--"
        if (value === "" || value === null || value === undefined) {
          return "--";
        }
        
        // For numeric values, format with 1 decimal place
        const numericValue = parseFloat(value);
        if (!isNaN(numericValue)) {
          // For EC values, round to whole number as they're likely to be larger numbers (μS/cm)
          if (sensorId === 'ec') {
            return Math.round(numericValue).toString();
          }
          return numericValue.toFixed(1);
        }
        
        // Return as is if not numeric
        return value;
      }
      
      // Function to save sensors to Firebase
      function saveSensorsToFirebase() {
        if (!database || !userUID) {
          saveSensorsToLocalStorage(); // Fallback to localStorage
          return;
        }
        
        try {
          // Get the product ID from the URL or use a default
          const urlParams = new URLSearchParams(window.location.search);
          const productId = urlParams.get('id') || 'default';
          
          // Get the sensors data to save (we don't need to save the full SVG icons to save space)
          const sensorsToSave = addedSensors.map(sensor => {
            // Create a copy without the icon
            const { icon, ...sensorWithoutIcon } = sensor;
            // Add just the sensor ID as a reference to the icon
            return {
              ...sensorWithoutIcon,
              iconId: sensor.id // We'll use this to look up the icon when loading
            };
          });
          
          // Reference to the user's sensors for this product
          const sensorsRef = ref(database, `users/${userUID}/products/${productId}/sensors`);
          
          // Save to Firebase
          set(sensorsRef, sensorsToSave)
            .then(() => {
              console.log("Sensors data saved to Firebase successfully");
            })
            .catch(error => {
              console.error("Error saving sensors to Firebase:", error);
              // Fallback to localStorage if Firebase save fails
              saveSensorsToLocalStorage();
            });
        } catch (error) {
          console.error("Error in saveSensorsToFirebase:", error);
          saveSensorsToLocalStorage();
        }
      }
      
      // Function to load sensors from Firebase
      function loadSensorsFromFirebase() {
        if (!database || !userUID) {
          loadSensorsFromLocalStorage();
          return;
        }
        
        try {
          // Get the product ID from the URL or use a default
          const urlParams = new URLSearchParams(window.location.search);
          const productId = urlParams.get('id') || 'default';
          
          // Reference to the user's sensors for this product
          const sensorsRef = ref(database, `users/${userUID}/products/${productId}/sensors`);
          
          // Get data from Firebase
          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
            firebaseDB.get(sensorsRef)
              .then((snapshot) => {
                if (snapshot.exists()) {
                  // We have saved sensor data
                  const sensorData = snapshot.val();
                  
                  // Convert the saved data back to full sensor objects
                  addedSensors = sensorData.map(savedSensor => {
                    // Find the sensor type to get the icon
                    const sensorType = sensorTypes.find(type => type.id === savedSensor.iconId);
                    
                    // Skip if sensorType is not found (e.g., if we've removed the EC sensor type)
                    if (!sensorType) {
                      console.log(`Skipping removed sensor type: ${savedSensor.iconId}`);
                      return null;
                    }
                    
                    // Merge the saved sensor with the icon from sensorTypes
                    return {
                      ...savedSensor,
                      icon: sensorType.icon
                    };
                  }).filter(sensor => sensor !== null); // Filter out null entries (removed sensors)
                  
                  console.log("Loaded sensors from Firebase:", addedSensors);
                  
                  // Set up listener for sensor data after sensors are loaded
                  setupSensorDataListener();
                  
                  updateUI();
                } else {
                  console.log("No sensors found in Firebase, checking localStorage");
                  loadSensorsFromLocalStorage();
                }
              })
              .catch(error => {
                console.error("Error loading sensors from Firebase:", error);
                loadSensorsFromLocalStorage();
              });
          }).catch(error => {
            console.error("Error importing Firebase Database for loading:", error);
            loadSensorsFromLocalStorage();
          });
        } catch (error) {
          console.error("Error in loadSensorsFromFirebase:", error);
          loadSensorsFromLocalStorage();
        }
      }
      
      // Function to save sensors to localStorage (fallback)
      function saveSensorsToLocalStorage() {
        try {
          // Get the product ID from the URL or use a default
          const urlParams = new URLSearchParams(window.location.search);
          const productId = urlParams.get('id') || 'default';
          
          // Get the sensors data to save (we don't need to save the full SVG icons to save space)
          const sensorsToSave = addedSensors.map(sensor => {
            // Create a copy without the icon
            const { icon, ...sensorWithoutIcon } = sensor;
            // Add just the sensor ID as a reference to the icon
            return {
              ...sensorWithoutIcon,
              iconId: sensor.id // We'll use this to look up the icon when loading
            };
          });
          
          // Save to localStorage with a key specific to this product
          localStorage.setItem(`waraf_sensors_${productId}`, JSON.stringify(sensorsToSave));
          console.log("Sensors saved to localStorage successfully");
        } catch (error) {
          console.error("Error saving sensors to localStorage:", error);
        }
      }
      
      // Function to load sensors from localStorage (fallback)
      function loadSensorsFromLocalStorage() {
        try {
          // Get the product ID from the URL or use a default
          const urlParams = new URLSearchParams(window.location.search);
          const productId = urlParams.get('id') || 'default';
          
          const savedSensors = localStorage.getItem(`waraf_sensors_${productId}`);
          
          if (savedSensors) {
            const sensorData = JSON.parse(savedSensors);
            
            // Convert the saved data back to full sensor objects
            addedSensors = sensorData.map(savedSensor => {
              // Find the sensor type to get the icon
              const sensorType = sensorTypes.find(type => type.id === savedSensor.iconId);
              
              // Skip if sensorType is not found (e.g., if we've removed the EC sensor type)
              if (!sensorType) {
                console.log(`Skipping removed sensor type: ${savedSensor.iconId}`);
                return null;
              }
              
              // Merge the saved sensor with the icon from sensorTypes
              return {
                ...savedSensor,
                icon: sensorType.icon
              };
            }).filter(sensor => sensor !== null); // Filter out null entries (removed sensors)
            
            console.log("Loaded sensors from localStorage:", addedSensors);
            
            // Set up listener for sensor data after sensors are loaded
            setupSensorDataListener();
            
            updateUI();
          } else {
            console.log("No sensors found in localStorage, starting fresh");
            
            // Still set up the sensor data listener
            setupSensorDataListener();
            
            updateUI();
          }
        } catch (error) {
          console.error("Error loading sensors from localStorage:", error);
          updateUI();
        }
      }
      
      // Render sensor options in the modal
      function renderSensorOptions() {
        sensorsList.innerHTML = '';
        
        sensorTypes.forEach(sensor => {
          const isAdded = addedSensors.some(s => s.id === sensor.id);
          const sensorOptionHTML = `
            <div class="sensor-option ${isAdded ? 'disabled' : ''}" data-sensor-id="${sensor.id}">
              <div class="sensor-option-checkbox">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div class="sensor-option-icon">
                <div class="sensor-option-icon-svg">
                  ${sensor.icon}
                </div>
              </div>
              <div class="sensor-option-name">${sensor.name}</div>
              <div class="sensor-option-desc">${sensor.description}</div>
            </div>
          `;
          
          sensorsList.innerHTML += sensorOptionHTML;
        });
        
        // Add click event to options
        document.querySelectorAll('.sensor-option:not(.disabled)').forEach(option => {
          option.addEventListener('click', function() {
            this.classList.toggle('selected');
          });
        });
      }
      
      // Update UI based on added sensors
      function updateUI() {
        if (addedSensors.length === 0) {
          sensorsEmptyState.style.display = 'flex';
          sensorsGridContainer.style.display = 'none';
        } else {
          sensorsEmptyState.style.display = 'none';
          sensorsGridContainer.style.display = 'block';
          renderSensorCards();
        }
      }
      
      // Render sensor cards in the grid
      function renderSensorCards() {
        sensorsGrid.innerHTML = '';
        
        addedSensors.forEach(sensor => {
          const sensorCard = document.createElement('div');
          sensorCard.className = 'sensor-card';
          sensorCard.setAttribute('data-sensor-id', sensor.id);
          sensorCard.setAttribute('draggable', 'true');
          
          // Get values from Firebase or fallback to default
          const valueFromFirebase = getSensorValue(sensor.id);
          const minFromFirebase = getSensorMin(sensor.id);
          const maxFromFirebase = getSensorMax(sensor.id);
          
          // Format the values (use -- for empty values)
          const formattedValue = formatSensorValue(valueFromFirebase, sensor.id, sensor);
          
          // Format min and max values - use Firebase values if available, otherwise use sensor defaults
          let formattedMin, formattedMax;
          
          if (minFromFirebase === "" || minFromFirebase === null || minFromFirebase === undefined) {
            formattedMin = "--";
          } else {
            const minValue = parseFloat(minFromFirebase);
            formattedMin = isNaN(minValue) ? "--" : minValue.toFixed(1);
          }
          
          if (maxFromFirebase === "" || maxFromFirebase === null || maxFromFirebase === undefined) {
            formattedMax = "--";
          } else {
            const maxValue = parseFloat(maxFromFirebase);
            formattedMax = isNaN(maxValue) ? "--" : maxValue.toFixed(1);
          }
          
          sensorCard.innerHTML = `
            <div class="sensor-actions">
              <button class="sensor-remove-btn" data-sensor-id="${sensor.id}">
                &times;
              </button>
            </div>
            <div class="sensor-icon-container">
              <div class="sensor-icon">
                ${sensor.icon}
              </div>
            </div>
            <div class="sensor-name">${sensor.name}</div>
            <div class="sensor-value">${formattedValue}<span class="sensor-unit">${sensor.unit}</span></div>
            <div class="sensor-range">
              <span>Min: ${formattedMin} ${sensor.unit}</span>
              <span>Max: ${formattedMax} ${sensor.unit}</span>
            </div>
          `;
          
          sensorsGrid.appendChild(sensorCard);
        });
        
        // Add remove button event listeners
        document.querySelectorAll('.sensor-remove-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const sensorId = this.getAttribute('data-sensor-id');
            removeSensor(sensorId);
          });
        });
        
        // Set up drag and drop functionality
        setupDragAndDrop();
      }
      
      // Add selected sensors
      function addSelectedSensors() {
        const selectedOptions = document.querySelectorAll('.sensor-option.selected');
        
        selectedOptions.forEach(option => {
          const sensorId = option.getAttribute('data-sensor-id');
          const sensorType = sensorTypes.find(s => s.id === sensorId);
          
          if (sensorType && !addedSensors.some(s => s.id === sensorId)) {
            // Clone the sensor type
            const sensor = { ...sensorType };
            
            // Get the value from Firebase if available, otherwise use default
            const valueFromFirebase = getSensorValue(sensorId);
            if (valueFromFirebase !== null && valueFromFirebase !== undefined && valueFromFirebase !== "") {
              sensor.value = parseFloat(valueFromFirebase);
            } else {
              // Fallback to default values
              const range = sensor.optimalMax - sensor.optimalMin;
              const randomOffset = Math.random() * range - (range / 2);
              sensor.value = sensor.defaultValue + randomOffset;
              sensor.value = Math.max(sensor.minValue, Math.min(sensor.value, sensor.maxValue));
            }
            
            addedSensors.push(sensor);
          }
        });
        
        updateUI();
        closeModal();
        
        // Save to Firebase/localStorage after adding sensors
        saveSensorsToFirebase();
      }
      
      // Remove a sensor
      function removeSensor(sensorId) {
        addedSensors = addedSensors.filter(s => s.id !== sensorId);
        updateUI();
        renderSensorOptions(); // Update available options in the modal
        
        // Save to Firebase/localStorage after removing a sensor
        saveSensorsToFirebase();
      }
      
      // Set up drag and drop functionality
      function setupDragAndDrop() {
        const cards = document.querySelectorAll('.sensor-card');
        cards.forEach(card => {
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
          card.addEventListener('dragover', handleDragOver);
          card.addEventListener('dragleave', handleDragLeave);
          card.addEventListener('drop', handleDrop);
        });
        
        // Also add events to the container for when dragging over empty areas
        sensorsGrid.addEventListener('dragover', handleContainerDragOver);
        sensorsGrid.addEventListener('drop', handleContainerDrop);
      }
      
      // Drag event handlers
      let draggedElement = null;
      
      function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.getAttribute('data-sensor-id'));
        
        // Create ghost image
        setTimeout(() => {
          this.style.opacity = '0.4';
        }, 0);
      }
      
      function handleDragEnd() {
        this.classList.remove('dragging');
        this.style.opacity = '';
        draggedElement = null;
        
        // Remove any drop indicators
        document.querySelectorAll('.sensor-card-ghost').forEach(el => el.remove());
      }
      
      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault(); // Allow drop
        }
        
        if (this !== draggedElement) {
          this.classList.add('drag-over');
        }
        
        return false;
      }
      
      function handleContainerDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault(); // Allow drop
        }
        
        // Only add ghost if not already present and we're not over another card
        if (!e.target.closest('.sensor-card') && !document.querySelector('.sensor-card-ghost')) {
          const ghost = document.createElement('div');
          ghost.className = 'sensor-card sensor-card-ghost';
          ghost.style.height = '180px';
          sensorsGrid.appendChild(ghost);
        }
        
        return false;
      }
      
      function handleDragLeave() {
        this.classList.remove('drag-over');
      }
      
      function handleDrop(e) {
        e.stopPropagation();
        
        if (draggedElement !== this) {
          // Get source and target indices based on DOM position
          const cards = Array.from(document.querySelectorAll('.sensor-card'));
          const sourceIndex = cards.indexOf(draggedElement);
          const targetIndex = cards.indexOf(this);
          
          // Reorder sensors array
          const [movedSensor] = addedSensors.splice(sourceIndex, 1);
          addedSensors.splice(targetIndex, 0, movedSensor);
          
          // Update the UI to reflect the new order
          renderSensorCards();
          
          // Save the new order to Firebase/localStorage
          saveSensorsToFirebase();
        }
        
        return false;
      }
      
      function handleContainerDrop(e) {
        e.preventDefault();
        
        // If dropped on container but not on a card, move to the end
        if (!e.target.closest('.sensor-card')) {
          const sensorId = e.dataTransfer.getData('text/plain');
          const sourceIndex = addedSensors.findIndex(s => s.id === sensorId);
          
          if (sourceIndex !== -1) {
            const [movedSensor] = addedSensors.splice(sourceIndex, 1);
            addedSensors.push(movedSensor);
            renderSensorCards();
            
            // Save the new order to Firebase/localStorage
            saveSensorsToFirebase();
          }
        }
        
        // Remove any ghost elements
        document.querySelectorAll('.sensor-card-ghost').forEach(el => el.remove());
        
        return false;
      }
      
      // Open the modal
      function openModal() {
        renderSensorOptions(); // Refresh options
        sensorsModal.classList.add('show');
      }
      
      // Close the modal
      function closeModal() {
        sensorsModal.classList.remove('show');
        
        // Deselect all options
        document.querySelectorAll('.sensor-option.selected').forEach(option => {
          option.classList.remove('selected');
        });
      }
      
      // Set up event listeners
      function setupEventListeners() {
        // Add sensors buttons
        addSensorsButtonEmpty.addEventListener('click', openModal);
        addSensorsButton.addEventListener('click', openModal);
        
        // Modal close buttons
        modalClose.addEventListener('click', closeModal);
        modalCancel.addEventListener('click', closeModal);
        
        // Outside click to close
        sensorsModal.addEventListener('click', function(e) {
          if (e.target === sensorsModal) {
            closeModal();
          }
        });
        
        // Add selected button
        modalAddSelected.addEventListener('click', addSelectedSensors);
        
        // Escape key to close modal
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && sensorsModal.classList.contains('show')) {
            closeModal();
          }
        });
      }
      
      // Initialize
      init();
    });
  </script>

  <!-- Professional AI Assistant -->
  <div id="ai-assistant-container">
    <button id="ai-assistant-button" aria-label="AI Assistant">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="4"></circle>
        <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
        <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
        <line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line>
        <line x1="4.93" y1="19.07" x2="9.17" y2="14.83"></line>
      </svg>
    </button>
    
    <div id="ai-chat-interface">
      <div class="ai-chat-header">
        <h3>Assistant</h3>
        <div class="ai-chat-header-buttons">
          <button id="ai-chat-new" aria-label="New Chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
          </button>
          <button id="ai-chat-close" aria-label="Close chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <div id="ai-chat-messages">
      </div>
      
      <div class="ai-chat-input-container">
        <input type="text" id="ai-chat-input" placeholder="Type your message..." aria-label="Message input">
        <button id="ai-chat-send" aria-label="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <style>
    /* Professional AI Assistant Styles */
    #ai-assistant-container {
      position: fixed;
      right: 30px;
      bottom: 30px;
      z-index: 9999;
    }
    
    #ai-assistant-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--accent-color);
      border: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      z-index: 10001;
    }
    
    #ai-assistant-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
    }
    
    #ai-assistant-button svg {
      width: 28px;
      height: 28px;
      stroke: white;
    }
    
    #ai-chat-interface {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 700px;
      height: 600px;
      max-width: 85vw;
      max-height: 80vh;
      background-color: #000000;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
      z-index: 10000;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    #ai-chat-interface.active {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .ai-chat-header {
      padding: 20px;
      background-color: #000000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ai-chat-header h3 {
      color: white;
      margin: 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    .ai-chat-header-buttons {
      display: flex;
      gap: 10px;
    }
    
    #ai-chat-close, #ai-chat-new {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    #ai-chat-close:hover, #ai-chat-new:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    #ai-chat-close svg, #ai-chat-new svg {
      width: 20px;
      height: 20px;
      stroke: rgba(255, 255, 255, 0.7);
    }
    
    #ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    #ai-chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    
    #ai-chat-messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 4px;
    }
    
    #ai-chat-messages::-webkit-scrollbar-thumb {
      background: rgba(56, 181, 147, 0.5);
      border-radius: 4px;
    }
    
    .ai-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 10px;
      line-height: 1.5;
      font-size: 0.95rem;
      animation: fadeIn 0.3s ease;
    }
    
    .ai-message.user-message {
      align-self: flex-end;
      background-color: rgba(56, 181, 147, 0.2);
      color: white;
      border-top-right-radius: 3px;
    }
    
    .ai-message.assistant-message {
      align-self: flex-start;
      background-color: #121212;
      color: rgba(255, 255, 255, 0.9);
      border-top-left-radius: 3px;
    }
    
    .ai-message.error-message {
      background-color: rgba(220, 53, 69, 0.2);
      color: #ffcccc;
      border-left: 3px solid #dc3545;
      align-self: stretch;
      max-width: 100%;
      border-radius: 6px;
    }
    
    .ai-chat-input-container {
      display: flex;
      padding: 15px 20px;
      gap: 12px;
      background-color: #000000;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    #ai-chat-input {
      flex: 1;
      background-color: #0a0a0a;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 12px 16px;
      border-radius: 8px;
      color: white;
      font-size: 0.95rem;
      outline: none;
      transition: all 0.2s ease;
    }
    
    #ai-chat-input:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(56, 181, 147, 0.2);
    }
    
    #ai-chat-send {
      background-color: var(--accent-color);
      width: 42px;
      height: 42px;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #ai-chat-send:hover {
      background-color: rgba(56, 181, 147, 0.8);
    }
    
    #ai-chat-send svg {
      width: 20px;
      height: 20px;
      stroke: white;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
    }
    
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background-color: var(--accent-color);
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(0.7); opacity: 0.5; }
      50% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  
  <script>
    // Professional AI Assistant Implementation
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const aiButton = document.getElementById('ai-assistant-button');
      const aiChatInterface = document.getElementById('ai-chat-interface');
      const aiChatClose = document.getElementById('ai-chat-close');
      const aiChatNew = document.getElementById('ai-chat-new');
      const aiChatInput = document.getElementById('ai-chat-input');
      const aiChatSend = document.getElementById('ai-chat-send');
      const aiChatMessages = document.getElementById('ai-chat-messages');
      
      // Variables
      let aiApiEndpoint = null;
      let openRouterApiKey = null;
      let aiModelName = "deepseek/deepseek-chat:free"; // Default model if not specified
      let useOpenRouter = false;
      
      // Initialize by fetching API endpoint from Firebase
      function initializeAIAssistant() {
        // Import Firebase modules
        import('https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js').then((firebaseApp) => {
          import('https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js').then((firebaseDB) => {
            // Get Firebase instances
            const db = firebaseDB.getDatabase();
            
            // Reference to the links node
            const linksRef = firebaseDB.ref(db, 'links');
            
            // Use onValue to listen for changes to the links node
            firebaseDB.onValue(linksRef, (snapshot) => {
              if (snapshot.exists()) {
                const linksData = snapshot.val();
                console.log('Raw data from Firebase links node:', linksData);
                
                // The links might be a string that needs parsing
                let links;
                if (typeof linksData === 'string' && linksData.startsWith('{')) {
                  try {
                    // Try to parse the string as JSON
                    links = JSON.parse(linksData);
                    console.log('Parsed links data:', links);
                  } catch (e) {
                    console.error('Error parsing links data:', e);
                    links = linksData; // Use as is if parsing fails
                  }
                } else {
                  links = linksData; // Use as is if it's not a JSON string
                }
                
                console.log('Links from Firebase for AI API (processed):', links);
                
                // Store both API options
                if (links.apiKey) {
                  openRouterApiKey = links.apiKey.trim();
                  console.log('OpenRouter API Key found');
                  useOpenRouter = true;
                  
                  // Store model name if provided
                  if (links.modelName) {
                    aiModelName = links.modelName.trim();
                    console.log('Using AI model:', aiModelName);
                  }
                  
                  // Test if OpenRouter key works
                  testOpenRouterConnection();
                } else {
                  console.log('No OpenRouter API Key found');
                  useOpenRouter = false;
                }
                
                if (links.aiAPI) {
                  // Clean the endpoint URL - remove any leading @ symbol
                  let endpoint = links.aiAPI.trim();
                  if (endpoint.startsWith('@')) {
                    endpoint = endpoint.substring(1);
                  }
                  
                  // Make sure the endpoint doesn't already end with /v1/chat/completions
                  if (!endpoint.endsWith('/v1/chat/completions')) {
                    // Add trailing slash if needed
                    if (!endpoint.endsWith('/')) {
                      endpoint += '/';
                    }
                    // Append the path
                    endpoint += 'v1/chat/completions';
                  }
                  
                  aiApiEndpoint = endpoint;
                  console.log('Cleaned AI API endpoint:', aiApiEndpoint);
                  
                  // If we have no OpenRouter key, start chat with the standard API
                  if (!openRouterApiKey) {
                    startNewChat();
                  }
                } else {
                  console.error('AI API endpoint not found in Firebase');
                  showApiError('API configuration not found in the system.');
                }
              } else {
                console.error('Links node not found in Firebase');
                showApiError('API configuration not found in the system.');
              }
            }, (error) => {
              console.error('Error listening to links from Firebase:', error);
              showApiError('Could not load API configuration from the system.');
            });
          }).catch(error => {
            console.error('Error importing Firebase Database:', error);
            showApiError('Could not initialize the database connection.');
          });
        }).catch(error => {
          console.error('Error importing Firebase App:', error);
          showApiError('Could not initialize the connection to the system.');
        });
      }
      
      // Test if OpenRouter API key works
      function testOpenRouterConnection() {
        console.log('Testing OpenRouter connection with model:', aiModelName);
        
        fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openRouterApiKey}`,
            'HTTP-Referer': window.location.origin
          },
          body: JSON.stringify({
            model: aiModelName,
            messages: [
              {
                role: "system",
                content: "Respond with only the word 'Connected' for connection test."
              },
              {
                role: "user",
                content: "Connection test"
              }
            ],
            max_tokens: 10
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`OpenRouter API test failed with status ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('OpenRouter test response:', data);
          if (data.choices && data.choices[0] && data.choices[0].message) {
            console.log('OpenRouter connection successful!');
            useOpenRouter = true;
            startNewChat();
          } else {
            throw new Error('Unexpected OpenRouter response format');
          }
        })
        .catch(error => {
          console.error('OpenRouter connection test failed:', error);
          console.log('Falling back to standard API endpoint');
          useOpenRouter = false;
          startNewChat();
        });
      }
      
      // Show API error message
      function showApiError(message) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'ai-message error-message';
        errorMessage.textContent = `Error: ${message} Please try again later or contact support if the problem persists.`;
        aiChatMessages.appendChild(errorMessage);
      }
      
      // Start a new chat
      function startNewChat() {
        // Clear messages
        aiChatMessages.innerHTML = '';
        
        // Add initial greeting
        const greeting = document.createElement('div');
        greeting.className = 'ai-message assistant-message';
        
        // Simple greeting without model information
        greeting.textContent = 'Hi, how can I help you?';
        
        aiChatMessages.appendChild(greeting);
        
        // Clear input
        aiChatInput.value = '';
      }
      
      // Function to add a user message
      function addUserMessage(content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message user-message';
        messageDiv.textContent = content;
        aiChatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
      }
      
      // Function to add an assistant message
      function addAssistantMessage(content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message assistant-message';
        messageDiv.textContent = ''; // Start empty
        aiChatMessages.appendChild(messageDiv);
        
        // Scroll to bottom initially
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        
        // Split the content into characters for a smoother effect
        const characters = content.split('');
        let charIndex = 0;
        
        // Function to add the next character
        function addNextCharacter() {
          if (charIndex < characters.length) {
            // Add the next character
            messageDiv.textContent += characters[charIndex];
            charIndex++;
            
            // Scroll to bottom as text is added
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            
            // Calculate variable delay for natural effect
            let delay;
            const currentChar = characters[charIndex - 1];
            const nextChar = characters[charIndex];
            
            // Slow down at the end of sentences and paragraphs
            if (['.', '!', '?'].includes(currentChar)) {
              delay = Math.floor(Math.random() * 100) + 200; // 200-300ms for end of sentences
            } 
            // Small pause after commas and semicolons
            else if ([',', ';', ':'].includes(currentChar)) {
              delay = Math.floor(Math.random() * 50) + 100; // 100-150ms for commas
            } 
            // Random regular typing speed
            else {
              delay = Math.floor(Math.random() * 20) + 15; // 15-35ms for normal characters
            }
            
            // Schedule the next character
            setTimeout(addNextCharacter, delay);
          }
        }
        
        // Start adding characters
        addNextCharacter();
      }
      
      // Function to show typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant-message typing-indicator';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        aiChatMessages.appendChild(typingDiv);
        
        // Scroll to bottom
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
      }
      
      // Function to remove typing indicator
      function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }
      
      // Function to send message to API
      function sendMessage(message) {
        // Check if API endpoint is available
        if (!useOpenRouter && !aiApiEndpoint) {
          showApiError('No API endpoint configured.');
          return;
        }
        
        // Show typing indicator
        showTypingIndicator();
        
        // Create a new message div for the response
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message assistant-message';
        messageDiv.textContent = ''; // Start empty
        
        // Add the message div to the chat
        aiChatMessages.appendChild(messageDiv);
        
        if (useOpenRouter) {
          // Using OpenRouter API
          console.log(`Sending request to OpenRouter using model: ${aiModelName}`);
          
          fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${openRouterApiKey}`,
              'HTTP-Referer': window.location.origin
            },
            body: JSON.stringify({
              model: aiModelName,
              messages: [
                {
                  role: "system",
                  content: "You are a hydroponic expert working for Waraf, a company specializing in solar-powered vertical hydroponic systems. Provide concise, direct answers to user questions without unnecessary elaboration. Always report temperature in Celsius (°C) only, never in Fahrenheit. Your expertise includes: 1) Plant growth in hydroponic environments, 2) Nutrient solution management (EC, pH, TDS optimization), 3) Environmental monitoring (temperature, humidity, CO2, light), 4) System maintenance and troubleshooting, 5) Crop selection and growth cycles, 6) Water and energy efficiency, 7) Sustainable practices in hydroponics. Answer questions accurately using scientific knowledge. Focus on practical advice for users managing Waraf's vertical hydroponic systems in hot, arid climates. Emphasize sustainable practices that align with Saudi Arabia's Vision 2030 food security goals."
                },
                {
                  role: "user",
                  content: message
                }
              ],
              max_tokens: 500,
              stream: true // Enable streaming response
            })
          })
          .then(response => {
            if (!response.ok) {
              // If OpenRouter fails, fall back to the original API
              console.log('OpenRouter request failed, falling back to standard API');
              useOpenRouter = false;
              
              // Remove the current message div
              messageDiv.remove();
              
              // Try again with the standard API
              sendMessage(message);
              return;
            }
            
            // Remove typing indicator
            removeTypingIndicator();
            
            // Create a text decoder
            const decoder = new TextDecoder();
            
            // Create a reader for streaming
            const reader = response.body.getReader();
            
            // Function to process the stream
            function processStream() {
              return reader.read().then(({ done, value }) => {
                if (done) {
                  console.log('Stream complete');
                  return;
                }
                
                // Decode the chunk
                const chunk = decoder.decode(value, { stream: true });
                
                try {
                  // Process data chunks
                  const lines = chunk.split('\n').filter(line => line.trim() !== '');
                  
                  for (const line of lines) {
                    // Skip data: prefix and parse JSON
                    if (line.startsWith('data:')) {
                      const jsonData = line.replace(/^data: /, '').trim();
                      
                      // Check for the end of the stream
                      if (jsonData === '[DONE]') {
                        return;
                      }
                      
                      try {
                        const parsedData = JSON.parse(jsonData);
                        
                        // Check if we have content to display
                        if (
                          parsedData.choices && 
                          parsedData.choices[0] && 
                          parsedData.choices[0].delta && 
                          parsedData.choices[0].delta.content
                        ) {
                          // Append the new content
                          const newContent = parsedData.choices[0].delta.content;
                          messageDiv.textContent += newContent;
                          
                          // Scroll to bottom
                          aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
                        }
                      } catch (e) {
                        console.error('Error parsing JSON:', e, jsonData);
                      }
                    }
                  }
                } catch (e) {
                  console.error('Error processing chunk:', e);
                }
                
                // Continue reading the stream
                return processStream();
              });
            }
            
            // Start processing the stream
            return processStream();
          })
          .catch(error => {
            console.error('Error with OpenRouter API:', error);
            
            // If there's an error with OpenRouter, fall back to the standard API
            console.log('OpenRouter error, falling back to standard API');
            useOpenRouter = false;
            
            // Remove the current message div
            messageDiv.remove();
            
            // Try again with the standard API
            sendMessage(message);
          });
        } else {
          // Using standard API endpoint
          console.log('Sending request to standard API:', aiApiEndpoint);
          
          fetch(aiApiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [
                {
                  role: "system",
                  content: "You are a hydroponic expert working for Waraf, a company specializing in solar-powered vertical hydroponic systems. Provide concise, direct answers to user questions without unnecessary elaboration. Always report temperature in Celsius (°C) only, never in Fahrenheit. Your expertise includes: 1) Plant growth in hydroponic environments, 2) Nutrient solution management (EC, pH, TDS optimization), 3) Environmental monitoring (temperature, humidity, CO2, light), 4) System maintenance and troubleshooting, 5) Crop selection and growth cycles, 6) Water and energy efficiency, 7) Sustainable practices in hydroponics. Answer questions accurately using scientific knowledge. Focus on practical advice for users managing Waraf's vertical hydroponic systems in hot, arid climates. Emphasize sustainable practices that align with Saudi Arabia's Vision 2030 food security goals."
                },
                {
                  role: "user",
                  content: message
                }
              ],
              max_tokens: 500,
              stream: true // Enable streaming response
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`API request failed with status ${response.status}`);
            }
            
            // Remove typing indicator
            removeTypingIndicator();
            
            // Create a text decoder
            const decoder = new TextDecoder();
            
            // Create a reader for streaming
            const reader = response.body.getReader();
            
            // Function to process the stream
            function processStream() {
              return reader.read().then(({ done, value }) => {
                if (done) {
                  console.log('Stream complete');
                  return;
                }
                
                // Decode the chunk
                const chunk = decoder.decode(value, { stream: true });
                
                try {
                  // Process data chunks
                  const lines = chunk.split('\n').filter(line => line.trim() !== '');
                  
                  for (const line of lines) {
                    // Skip data: prefix and parse JSON
                    if (line.startsWith('data:')) {
                      const jsonData = line.replace(/^data: /, '').trim();
                      
                      // Check for the end of the stream
                      if (jsonData === '[DONE]') {
                        return;
                      }
                      
                      try {
                        const parsedData = JSON.parse(jsonData);
                        
                        // Check if we have content to display
                        if (
                          parsedData.choices && 
                          parsedData.choices[0] && 
                          parsedData.choices[0].delta && 
                          parsedData.choices[0].delta.content
                        ) {
                          // Append the new content
                          const newContent = parsedData.choices[0].delta.content;
                          messageDiv.textContent += newContent;
                          
                          // Scroll to bottom
                          aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
                        }
                      } catch (e) {
                        console.error('Error parsing JSON:', e, jsonData);
                      }
                    }
                  }
                } catch (e) {
                  console.error('Error processing chunk:', e);
                }
                
                // Continue reading the stream
                return processStream();
              });
            }
            
            // Start processing the stream
            return processStream();
          })
          .catch(error => {
            console.error('Error sending message to API:', error);
            removeTypingIndicator();
            
            // Show error message
            const errorMessage = document.createElement('div');
            errorMessage.className = 'ai-message error-message';
            errorMessage.textContent = `Error: Could not connect to the AI service. ${error.message}`;
            aiChatMessages.appendChild(errorMessage);
            
            // Scroll to bottom
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
          });
        }
      }
      
      // Event listeners
      
      // Toggle chat interface
      aiButton.addEventListener('click', function() {
        aiChatInterface.classList.add('active');
        aiChatInput.focus();
      });
      
      // Close chat interface
      aiChatClose.addEventListener('click', function() {
        aiChatInterface.classList.remove('active');
      });
      
      // Start new chat
      aiChatNew.addEventListener('click', startNewChat);
      
      // Send message on button click
      aiChatSend.addEventListener('click', function() {
        const message = aiChatInput.value.trim();
        if (message) {
          addUserMessage(message);
          aiChatInput.value = '';
          sendMessage(message);
        }
      });
      
      // Send message on Enter key press
      aiChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const message = aiChatInput.value.trim();
          if (message) {
            addUserMessage(message);
            aiChatInput.value = '';
            sendMessage(message);
          }
        }
      });
      
      // Initialize AI Assistant
      initializeAIAssistant();
    });
  </script>
</body>

</html> 